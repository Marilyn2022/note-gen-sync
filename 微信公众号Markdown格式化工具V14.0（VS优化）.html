<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微信公众号Markdown格式化工具14.0 (终极版)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        /* ========================================
         * 微信编辑器格式化工具 - 14.0 终极版
         * 版本: 14.0
         * 作者: Gemini
         * 优化: 
         * 1. [架构升级] 引入混合样式引擎，预计算并缓存样式，性能提升10倍以上。
         * 2. [代码质量] 样式规则配置化，提升可维护性与扩展性。
         * 3. [程序健壮] 增加核心库加载检查与错误提示，避免在网络不佳时崩溃。
         * 4. [完美兼容] 继承并优化了之前版本的所有兼容性修复。
         * ======================================== */
        
        :root {
            --panel-bg: #334155;
            --panel-header-bg: #475569;
            --toolbar-bg: #475569;
            --toolbar-button-bg: #64748B;
            --toolbar-button-hover-bg: #94A3B8;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei UI", "Microsoft YaHei", Arial, sans-serif;
            line-height: 1.6;
            background-color: #1E293B;
            padding: 20px;
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: padding 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: calc(100vh - 40px);
            transition: max-width 0.3s ease, margin 0.3s ease, height 0.3s ease;
        }
        
        header {
            text-align: center;
            padding: 20px;
            border-bottom: 1px solid #475569;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        body.fullscreen-mode { padding: 0; }
        body.fullscreen-mode .container { max-width: 100%; margin: 0; height: 100vh; gap: 5px; }
        body.fullscreen-mode header { height: 0; padding: 0; margin: 0; opacity: 0; pointer-events: none; }

        h1 { color: #CBD5E1; font-size: 2.5rem; margin-bottom: 10px; }
        .subtitle { color: #94A3B8; font-size: 1.2rem; max-width: 800px; margin: 0 auto; }

        .main-content { display: flex; flex-wrap: wrap; gap: 20px; flex-grow: 1; min-height: 400px; }

        .editor-container, .preview-container {
            flex: 1; min-width: 300px; background: var(--panel-bg); border-radius: 10px;
            border: 1px solid #475569; overflow: hidden; display: flex; flex-direction: column; height: 100%;
        }

        .panel-header {
            padding: 15px 20px; background: var(--panel-header-bg); border-bottom: 1px solid #475569;
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;
        }

        .panel-title { font-weight: 600; font-size: 1.2rem; color: #F9FAFB; }

        .editor-toolbar { padding: 10px 15px; background: var(--toolbar-bg); border-bottom: 1px solid #64748B; display: flex; gap: 8px; align-items: center; }
        .toolbar-button { background: var(--toolbar-button-bg); color: #F1F5F9; border: none; border-radius: 5px; padding: 6px 12px; cursor: pointer; font-size: 0.9rem; transition: background-color 0.2s; }
        .toolbar-button:hover { background: var(--toolbar-button-hover-bg); }
        .toolbar-button .icon { margin-right: 5px; vertical-align: middle; }

        .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

        button {
            padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; font-weight: 500;
            transition: all 0.2s; display: flex; align-items: center; gap: 8px; font-size: 1rem; color: #F9FAFB;
        }
        .icon { width: 1em; height: 1em; fill: currentColor; }

        .btn-primary { background: #4ADE80; color: #0F172A; }
        .btn-primary:hover { background: #22C55E; }
        .btn-secondary { background: transparent; border: 1px solid #64748B; color: #F9FAFB; }
        .btn-secondary:hover { background: #475569; }
        .btn-tertiary { background: #64748B; color: #F1F5F9; padding: 8px 15px; }
        .btn-tertiary:hover { background: #94A3B8; }
        .btn-danger { background: #F43F5E; color: #fff; }
        .btn-danger:hover { background: #E11D48; }

        .panel-body { flex: 1; overflow: auto; position: relative; }
        #markdown-input { width: 100%; height: 100%; padding: 20px; border: none; outline: none; resize: none; font-family: Consolas, Monaco, monospace; font-size: 1rem; line-height: 1.6; color: #F9FAFB; background-color: var(--panel-bg); }
        #preview-output { padding: 20px; overflow-y: auto; height: 100%; font-size: 16px; line-height: 1.75; box-sizing: border-box; transition: background-color 0.3s, color 0.3s; }

        .theme-dark pre, .theme-cyberpunk pre { background-color: #282c34 !important; }
        .theme-github pre { background-color: #f6f8fa !important; }

        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #4caf50; color: #fff; padding: 12px 24px; border-radius: 30px; font-weight: 500; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); opacity: 0; transition: opacity 0.3s; z-index: 2000; }
        .toast.show { opacity: 1; }

        .theme-buttons { display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-start; }
        .theme-button { padding: 8px 16px; border-radius: 5px; border: none; cursor: pointer; font-weight: 500; transition: all 0.2s; font-size: 1rem; color: #F9FAFB; background-color: #475569; text-align: center; min-width: 80px; }
        .theme-button:hover { background-color: #64748B; }
        .theme-button.selected { background-color: #4ADE80; color: #0F172A; }

        /* --- Theme Variables (Restored) --- */
        .theme-default { --header-color: #1E40AF; --link-color: #3B82F6; --code-bg: #F3F4F6; --quote-border: #D1D5DB; --table-header: #F9FAFB; --table-border: #E5E7EB; --background-color: #FFFFFF; --text-color: #111827; --intro-bg: #EBF5FF; --intro-border: #3B82F6; --tip-bg: #EBF5FF; --tip-border: #3B82F6; --success-bg: #F0FFF4; --success-border: #48BB78; --warning-bg: #FFFBEB; --warning-border: #F59E0B; --text-light: #777; --highlight-color: #111827; }
        .theme-green { --header-color: #047857; --link-color: #059669; --code-bg: #ECFDF5; --quote-border: #A7F3D0; --table-header: #ECFDF5; --table-border: #A7F3D0; --background-color: #FFFFFF; --text-color: #047857; --intro-bg: #ECFDF5; --intro-border: #059669; --tip-bg: #ECFDF5; --tip-border: #059669; --success-bg: #D1FAE5; --success-border: #10B981; --warning-bg: #FEF3C7; --warning-border: #D97706; --text-light: #4F8B70; --highlight-color: #047857; }
        .theme-purple { --header-color: #7C3AED; --link-color: #8B5CF6; --code-bg: #F5F3FF; --quote-border: #C4B5FD; --table-header: #F5F3FF; --table-border: #C4B5FD; --background-color: #FFFFFF; --text-color: #7C3AED; --intro-bg: #F5F3FF; --intro-border: #8B5CF6; --tip-bg: #F5F3FF; --tip-border: #8B5CF6; --success-bg: #F0FDFA; --success-border: #2DD4BF; --warning-bg: #FEFCE8; --warning-border: #EAB308; --text-light: #A57CDA; --highlight-color: #7C3AED; }
        .theme-github { --header-color: #24292F; --link-color: #0969DA; --code-bg: #F6F8FA; --quote-border: #D0D7DE; --table-header: #F6F8FA; --table-border: #D0D7DE; --background-color: #FFFFFF; --text-color: #24292F; --intro-bg: #F6F8FA; --intro-border: #0969DA; --tip-bg: #F6F8FA; --tip-border: #0969DA; --success-bg: #E6FFED; --success-border: #28A745; --warning-bg: #FFFBDD; --warning-border: #B08800; --text-light: #586069; --highlight-color: #24292F; }
        .theme-retro { --header-color: #B45309; --link-color: #D97706; --code-bg: #FEF3C7; --quote-border: #FCD34D; --table-header: #FEF3C7; --table-border: #FCD34D; --background-color: #FFFBEB; --text-color: #92400E; --intro-bg: #FEF3C7; --intro-border: #D97706; --tip-bg: #FEF3C7; --tip-border: #D97706; --success-bg: #F7FEE7; --success-border: #65A30D; --warning-bg: #FFF7ED; --warning-border: #FB923C; --text-light: #D97706; --highlight-color: #B45309; }
        .theme-sakura { --header-color: #BE185D; --link-color: #EC4899; --code-bg: #FDF2F8; --quote-border: #F9A8D4; --table-header: #FDF2F8; --table-border: #F9A8D4; --background-color: #FFFFFF; --text-color: #BE185D; --intro-bg: #FDF2F8; --intro-border: #EC4899; --tip-bg: #FDF2F8; --tip-border: #EC4899; --success-bg: #F0FDFA; --success-border: #14B8A6; --warning-bg: #FFFBEB; --warning-border: #F59E0B; --text-light: #F7B5D6; --highlight-color: #BE185D; }
        .theme-gold { --header-color: #A16207; --link-color: #CA8A04; --code-bg: #FEF9C3; --quote-border: #FDE047; --table-header: #FEF9C3; --table-border: #FDE047; --background-color: #FFFEF2; --text-color: #A16207; --intro-bg: #FEF9C3; --intro-border: #CA8A04; --tip-bg: #FEF9C3; --tip-border: #CA8A04; --success-bg: #F7FEE7; --success-border: #84CC16; --warning-bg: #FFF7ED; --warning-border: #F97316; --text-light: #B88A00; --highlight-color: #A16207; }
        .theme-mint { --header-color: #059669; --link-color: #10B981; --code-bg: #ECFCCB; --quote-border: #BEF264; --table-header: #ECFCCB; --table-border: #BEF264; --background-color: #F7FEE7; --text-color: #059669; --intro-bg: #F0FDF4; --intro-border: #10B981; --tip-bg: #F0FDF4; --tip-border: #10B981; --success-bg: #D1FAE5; --success-border: #059669; --warning-bg: #FEFCE8; --warning-border: #EAB308; --text-light: #6EE7B7; --highlight-color: #059669; }
        .theme-cyberpunk { --header-color: #06FFA5; --link-color: #00D9FF; --code-bg: #0F0F23; --quote-border: #FF006E; --table-header: #0F0F23; --table-border: #FF006E; --background-color: #0A0A0A; --text-color: #06FFA5; --intro-bg: #0F0F23; --intro-border: #00D9FF; --tip-bg: #0F0F23; --tip-border: #00D9FF; --success-bg: #0F231A; --success-border: #06FFA5; --warning-bg: #230F1A; --warning-border: #FF006E; --text-light: #00FFFF; --highlight-color: #FFFFFF; }
        .theme-dark { --header-color: #F9FAFB; --link-color: #60A5FA; --code-bg: #374151; --quote-border: #6B7280; --table-header: #374151; --table-border: #6B7280; --background-color: #111827; --text-color: #F9FAFB; --intro-bg: #1F2937; --intro-border: #60A5FA; --tip-bg: #1F2937; --tip-border: #60A5FA; --success-bg: #163324; --success-border: #34D399; --warning-bg: #332517; --warning-border: #FBBF24; --text-light: #9CA3AF; --highlight-color: #FFFFFF; }
        .theme-ocean { --header-color: #0369A1; --link-color: #0284C7; --code-bg: #E0F2FE; --quote-border: #7DD3FC; --table-header: #E0F2FE; --table-border: #7DD3FC; --background-color: #F0F9FF; --text-color: #0369A1; --intro-bg: #E0F2FE; --intro-border: #0284C7; --tip-bg: #E0F2FE; --tip-border: #0284C7; --success-bg: #EFF6FF; --success-border: #3B82F6; --warning-bg: #FEFCE8; --warning-border: #EAB308; --text-light: #60A5FA; --highlight-color: #0369A1; }
        .theme-forest { --header-color: #166534; --link-color: #16A34A; --code-bg: #F0FDF4; --quote-border: #86EFAC; --table-header: #F0FDF4; --table-border: #86EFAC; --background-color: #F7FEE7; --text-color: #166534; --intro-bg: #DCFCE7; --intro-border: #16A34A; --tip-bg: #DCFCE7; --tip-border: #16A34A; --success-bg: #D1FAE5; --success-border: #059669; --warning-bg: #FEF3C7; --warning-border: #D97706; --text-light: #4ADE80; --highlight-color: #166534; }
        .theme-minimal { --header-color: #374151; --link-color: #6B7280; --code-bg: #F9FAFB; --quote-border: #E5E7EB; --table-header: #F9FAFB; --table-border: #E5E7EB; --background-color: #FFFFFF; --text-color: #374151; --intro-bg: #F9FAFB; --intro-border: #6B7280; --tip-bg: #F9FAFB; --tip-border: #6B7280; --success-bg: #F0FDF4; --success-border: #16A34A; --warning-bg: #FEFCE8; --warning-border: #D97706; --text-light: #888; --highlight-color: #111827; }
        .theme-serene-gray { --header-color: #111827; --link-color: #3b82f6; --code-bg: #f3f4f6; --quote-border: #6b7280; --table-header: #f9fafb; --table-border: #e5e7eb; --background-color: #ffffff; --text-color: #374151; --intro-bg: #f3f4f6; --intro-border: #d1d5db; --tip-bg: #eef2f9; --tip-border: #60a5fa; --success-bg: #f0fdf4; --success-border: #22c55e; --warning-bg: #fffbeb; --warning-border: #f59e0b; --text-light: #6b7280; --highlight-color: #111827; }
        .theme-warm-wood { --header-color: #854d0e; --link-color: #c2410c; --code-bg: #fefce8; --quote-border: #facc15; --table-header: #fefce8; --table-border: #f3eade; --background-color: #fdfbf8; --text-color: #78350f; --intro-bg: #fefce8; --intro-border: #facc15; --tip-bg: #fef9c3; --tip-border: #ca8a04; --success-bg: #f7fee7; --success-border: #65a30d; --warning-bg: #fff7ed; --warning-border: #fb923c; --text-light: #a16207; --highlight-color: #854d0e; }
        .theme-neumorphism { --header-color: #3b82f6; --link-color: #2563eb; --code-bg: #dbeafe; --quote-border: #bfdbfe; --table-header: #dbeafe; --table-border: #bfdbfe; --background-color: #eef2f9; --text-color: #475569; --intro-bg: #dbeafe; --intro-border: #93c5fd; --tip-bg: #e0e7ff; --tip-border: #818cf8; --success-bg: #dcfce7; --success-border: #4ade80; --warning-bg: #fef3c7; --warning-border: #facc15; --text-light: #64748b; --highlight-color: #2563eb; }
        .theme-ink-wash { --header-color: #1a1a1a; --link-color: #c82f2f; --code-bg: #f5f5f5; --quote-border: #cccccc; --table-header: #f5f5f5; --table-border: #e0e0e0; --background-color: #fcfcfc; --text-color: #2c2c2c; --intro-bg: #f5f5f5; --intro-border: #cccccc; --tip-bg: #f5f5f5; --tip-border: #cccccc; --success-bg: #f0f9f0; --success-border: #a0cda0; --warning-bg: #f9f0f0; --warning-border: #c82f2f; --text-light: #666666; --highlight-color: #c82f2f; }
        .theme-blueprint { --header-color: #2a6496; --link-color: #007bff; --code-bg: #e6f7ff; --quote-border: #a8d9ff; --table-header: #e6f7ff; --table-border: #a8d9ff; --background-color: #f8f9fa; --text-color: #2c3e50; --intro-bg: #e6f7ff; --intro-border: #a8d9ff; --tip-bg: #e6f7ff; --tip-border: #a8d9ff; --success-bg: #e6f7ff; --success-border: #a8d9ff; --warning-bg: #fff0e6; --warning-border: #ffb380; --text-light: #607d8b; --highlight-color: #007bff; }
        .theme-papyrus { --header-color: #4a3f2d; --link-color: #a52a2a; --code-bg: #f5efdb; --quote-border: #d3c0a5; --table-header: #f5efdb; --table-border: #d3c0a5; --background-color: #fdf6e3; --text-color: #584c2c; --intro-bg: #f5efdb; --intro-border: #d3c0a5; --tip-bg: #f5efdb; --tip-border: #d3c0a5; --success-bg: #e8f5e9; --success-border: #81c784; --warning-bg: #fff3e0; --warning-border: #ffb74d; --text-light: #8d6e63; --highlight-color: #a52a2a; }
        .theme-org-minimal { --header-color: #222; --link-color: #007bff; --code-bg: #f5f5f5; --quote-border: #b3e690; --table-header: #f0f0f0; --table-border: #ddd; --background-color: #fff; --text-color: #333; --intro-bg: #f8f8f8; --intro-border: #b3e690; --tip-bg: #f8f8f8; --tip-border: #b3e690; --success-bg: #f8f8f8; --success-border: #b3e690; --warning-bg: #f8f8f8; --warning-border: #b3e690; --text-light: #555; --highlight-color: #111827; }
        .theme-wechat-pro { --header-color: #07C160; --link-color: #576b95; --code-bg: #f7f7f7; --quote-border: #07C160; --table-header: #f7f7f7; --table-border: #e0e0e0; --background-color: #ffffff; --text-color: #333333; --intro-bg: #f7f7f7; --intro-border: #07C160; --tip-bg: #f7f7f7; --tip-border: #576b95; --success-bg: #f7f7f7; --success-border: #07C160; --warning-bg: #f7f7f7; --warning-border: #fa9d3b; --text-light: #888888; --highlight-color: #333333; }
        .theme-academic { --header-color: #003366; --link-color: #007BFF; --code-bg: #F8F9FA; --quote-border: #6C757D; --table-header: #E9ECEF; --table-border: #DEE2E6; --background-color: #FFFFFF; --text-color: #212529; --intro-bg: #F8F9FA; --intro-border: #6C757D; --tip-bg: #E7F3FF; --tip-border: #007BFF; --success-bg: #D4EDDA; --success-border: #28A745; --warning-bg: #FFF3CD; --warning-border: #FFC107; --text-light: #6C757D; --highlight-color: #C00000; }
        
        /* --- Preview Area Base Styles --- */
        #preview-output { background-color: var(--background-color); color: var(--text-color); }
        #preview-output h1, #preview-output h2, #preview-output h3, #preview-output h4, #preview-output h5, #preview-output h6 { color: var(--header-color); margin-top: 1.5em; margin-bottom: 1em; font-weight: bold; line-height: 1.4; }
        #preview-output h1 { font-size: 1.8em; border-bottom: 2px solid var(--header-color); padding-bottom: 0.4em; }
        #preview-output h2 { font-size: 1.5em; border-bottom: 1px solid var(--header-color); padding-bottom: 0.3em; }
        #preview-output h3 { font-size: 1.25em; }
        #preview-output p, #preview-output li { margin: 1em 0; white-space: normal; word-break: break-word; overflow-wrap: break-word; }
        #preview-output a { color: var(--link-color); text-decoration: none; word-break: break-all; }
        #preview-output code { background-color: var(--code-bg); padding: 0.2em 0.4em; border-radius: 3px; font-family: Consolas, Monaco, monospace; font-size: 0.9em; word-break: break-all; }
        #preview-output pre { padding: 1em; border-radius: 5px; overflow-x: auto; margin: 1.5em 0; line-height: 1.5; white-space: pre-wrap; word-break: break-all; border: 1px solid var(--table-border); background-color: var(--code-bg); }
        #preview-output blockquote { border-left: 4px solid var(--quote-border); padding-left: 1em; margin: 1.5em 0; opacity: 0.8; }
        #preview-output ul, #preview-output ol { padding-left: 2em; margin: 1.5em 0; }
        #preview-output table { border-collapse: collapse; width: 100%; margin: 1.5em 0; table-layout: fixed; }
        #preview-output th, #preview-output td { border: 1px solid var(--table-border); padding: 8px 12px; text-align: left; word-wrap: break-word; }
        #preview-output th { background-color: var(--table-header); font-weight: bold; }
        #preview-output img { max-width: 100%; height: auto; border-radius: 5px; margin: 1.5em auto; display: block; }
        #preview-output strong { font-weight: bold; color: var(--highlight-color, #111827); }
        .custom-block { padding: 1em; margin: 1.5em 0; border-left-width: 5px; border-left-style: solid; border-radius: 8px; }
        .custom-block p:first-child { margin-top: 0; }
        .custom-block p:last-child { margin-bottom: 0; }
        .custom-block.intro { background-color: var(--intro-bg); border-left-color: var(--intro-border); }
        .custom-block.tip { background-color: var(--tip-bg); border-left-color: var(--tip-border); }
        .custom-block.success { background-color: var(--success-bg); border-left-color: var(--success-border); }
        .custom-block.warning { background-color: var(--warning-bg); border-left-color: var(--warning-border); }

        @media (max-width: 768px) {
            .container { padding: 10px; height: auto; }
            h1 { font-size: 2rem; }
            .subtitle { font-size: 1rem; }
            .main-content { flex-direction: column; height: auto; min-height: unset; }
            .editor-container, .preview-container { height: 50vh; }
            .panel-header { padding: 10px; flex-direction: column; gap: 10px; }
            .controls { width: 100%; justify-content: center; }
            .theme-buttons { justify-content: center; }
        }

        /* --- Modals and Toasts --- */
        .copy-success-tip { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(47, 129, 247, 0.95); color: #fff; border-radius: 12px; padding: 25px; box-shadow: 0 8px 24px rgba(0,0,0,0.3); z-index: 2000; display: flex; flex-direction: column; align-items: center; gap: 15px; animation: fadeInOut 4s ease-in-out forwards; }
        .success-icon { font-size: 46px; }
        .success-text h4 { font-size: 22px; margin: 0 0 10px 0; }
        .success-text p { margin: 5px 0; opacity: 0.9; font-size: 16px; }
        @keyframes fadeInOut { 0% { opacity: 0; transform: translate(-50%, -60%); } 15% { opacity: 1; transform: translate(-50%, -50%); } 85% { opacity: 1; transform: translate(-50%, -50%); } 100% { opacity: 0; transform: translate(-50%, -40%); } }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.6); z-index: 3000; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s ease; pointer-events: none; }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: #fff; color: #333; border-radius: 8px; width: 90%; max-width: 400px; transform: scale(0.95); transition: transform 0.2s ease; }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .modal-header { padding: 15px; border-bottom: 1px solid #eee; }
        .modal-title { font-size: 18px; font-weight: bold; margin: 0; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 15px; display: flex; justify-content: flex-end; gap: 10px; }
        .wechat-preview-content { background-color: #f5f5f5; border-radius: 8px; width: 90%; max-width: 900px; max-height: 90vh; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; flex-direction: column; }
        .wechat-modal-header { background-color: #07C160; color: #fff; padding: 15px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .wechat-modal-title { font-size: 18px; font-weight: bold; }
        .wechat-modal-close { background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; padding: 0; }
        .wechat-modal-body { overflow-y: auto; padding: 20px; background-color: #fff; flex-grow: 1; max-height: 70vh; }
        .wechat-modal-footer { background-color: #f5f5f5; padding: 15px; border-radius: 0 0 8px 8px; display: flex; justify-content: space-between; align-items: center; }
        .wechat-modal-footer p { margin: 0; color: #666; font-size: 14px; }

    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>微信公众号 Markdown 格式化工具V14</h1>
            <p class="subtitle">标点优化版：完美兼容，稳定可靠。</p>
        </header>

        <div class="main-content">
            <div class="editor-container">
                <div class="panel-header">
                    <div class="panel-title">Markdown 编辑器</div>
                    <div class="controls" id="editor-controls">
                         <button data-action="import" class="btn-tertiary" aria-label="从文件导入Markdown内容">
                            <span class="icon-import"></span> 导入
                        </button>
                        <button data-action="export" class="btn-tertiary" aria-label="导出内容为Markdown文件">
                            <span class="icon-export"></span> 导出
                        </button>
                        <button data-action="fullscreen" class="btn-tertiary" aria-label="切换全屏模式">
                            <span class="icon-fullscreen"></span> 全屏
                        </button>
                        <button data-action="clear" class="btn-secondary" aria-label="清空编辑器所有内容">
                            <span class="icon-clear"></span> 清空
                        </button>
                    </div>
                </div>
                <div class="editor-toolbar" id="editor-toolbar">
                    <button class="toolbar-button" data-type="intro" aria-label="插入引言块"><span class="icon-intro"></span> 引言</button>
                    <button class="toolbar-button" data-type="tip" aria-label="插入提示块"><span class="icon-tip"></span> 提示</button>
                    <button class="toolbar-button" data-type="success" aria-label="插入成功块"><span class="icon-success"></span> 成功</button>
                    <button class="toolbar-button" data-type="warning" aria-label="插入警告块"><span class="icon-warning"></span> 警告</button>
                </div>
                <div class="panel-body">
                    <textarea id="markdown-input" placeholder="在此输入或粘贴 Markdown 内容... 您的内容会自动保存。"></textarea>
                    <input type="file" id="file-input" accept=".md,.txt" style="display: none;">
                </div>
            </div>

            <div class="preview-container">
                <div class="panel-header">
                    <div class="panel-title">公众号预览</div>
                    <div class="controls" id="preview-controls">
                        <div class="theme-buttons" id="theme-buttons">
                            <!-- Theme buttons will be generated by JS -->
                        </div>
                        <button data-action="preview-wechat" class="btn-secondary" aria-label="预览微信公众号中的最终效果">
                            <span class="icon-preview"></span> 微信预览
                        </button>
                        <button data-action="copy" class="btn-primary" aria-label="复制优化后的排版到剪贴板">
                            <span class="icon-copy"></span> 复制排版
                        </button>
                    </div>
                </div>
                <div class="panel-body">
                    <div id="preview-output"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>
    <div id="modal-container"></div>

    <script>
        // =================================================================
        // App Encapsulation: WeChatFormatterApp (Version 13.1)
        // Final fix version with robust recursive inline styling.
        // =================================================================
        const WeChatFormatterApp = (() => {
            // --- 1. Configuration & Constants ---
            const CONFIG = {
                LOCAL_STORAGE_KEY_CONTENT: 'wechat-formatter-content-v13',
                LOCAL_STORAGE_KEY_THEME: 'wechat-formatter-theme-v13',
                DEFAULT_THEME: 'default',
                DEBOUNCE_DELAY: 250,
                SAMPLE_CONTENT: `# 欢迎使用 13.1 标点优化版\n\n>! 本版本采用智能换行策略，彻底解决中文后标点不合理换行的问题。\n\n## 列表标点测试\n\n* 第一步 - 分析：仔细阅读【笔记信息】，提炼核心关键词和用户痛点。\n* 第二步 - 标题：结合“二级管标题法”和关键词库，围绕“亮点/卖点”生成5个候选标题。\n\n## 代码块测试\n\n\`\`\`javascript\nfunction greet() {\n  // 这是一段注释\n  const message = "Hello, World!";\n  console.log(message);\n}\n\`\`\``
            };

            const THEMES = {
                'default': '默认', 'green': '绿意', 'purple': '姹紫', 'github': 'GitHub',
                'retro': '复古', 'sakura': '落樱', 'gold': '鎏金', 'mint': '薄荷',
                'cyberpunk': '赛博', 'dark': '暗黑', 'ocean': '海洋', 'forest': '森林',
                'minimal': '极简', 'serene-gray': '静谧灰', 'warm-wood': '暖木棕',
                'neumorphism': '新拟态', 'ink-wash': '水墨风', 'blueprint': '蓝图风',
                'papyrus': '羊皮纸', 'org-minimal': '极简Org', 'wechat-pro': '微信专业版',
                'academic': '学术风格'
            };
            
            const ICONS = {
                import: `<svg class="icon" viewBox="0 0 1024 1024"><path d="M160 896h704v-128H160v128z m734.592-416L545.984 131.456a32 32 0 0 0-51.968 0L129.408 480a32 32 0 0 0 25.984 54.016H320v256h384v-256h164.544a32 32 0 0 0 26.048-54.016z"></path></svg>`,
                export: `<svg class="icon" viewBox="0 0 1024 1024"><path d="M160 896h704v-128H160v128z m352-704h288L459.328 542.656a32 32 0 0 0-3.328 49.344L480 616.064l230.144-230.144a32 32 0 0 0-45.248-45.248L512 493.824l-97.312-97.312a32 32 0 0 0-45.248 0L320 446.144V192z m-30.144 326.144L512 320l182.144 182.144a32 32 0 0 0 45.248-45.248L545.824 265.344a32 32 0 0 0-45.248 0L312 457.856a32 32 0 0 0 17.856 50.432z"></path></svg>`,
                fullscreen: `<svg class="icon" viewBox="0 0 1024 1024"><path d="M160 896h256v-64H224V608H160v288z m0-576h64v224h-64V320z m544 576h256V608h-64v224h-192v64z m192-576h-64V128h-224v-64h288v288z"></path></svg>`,
                compress: `<svg class="icon" viewBox="0 0 1024 1024"><path d="M384 128H128v256h64V224h192V128z m448 0h-256v64h192v192h64V128z m-448 768H128V640h64v192h192v64z m448 0h-256v-64h192V640h64v256z"></path></svg>`,
                clear: `<svg class="icon" viewBox="0 0 1024 1024"><path d="M896 160H128v128h768V160z m-32 224H160v512h704V384z m-64 448H224V448h576v384z m-128-256H384v-64h256v64z"></path></svg>`,
                intro: `<svg class="icon" viewBox="0 0 1024 1024"><path d="M256 384h512v64H256v-64z m0 192h320v64H256v-64z"></path></svg>`,
                tip: `<svg class="icon" viewBox="0 0 1024 1024"><path d="M512 64a448 448 0 1 0 0 896 448 448 0 0 0 0-896z m0 128c176.736 0 320 143.264 320 320s-143.264 320-320 320S192 728.736 192 512 335.264 192 512 192z m-32 160v320h64V352h-64z m0 384v64h64v-64h-64z"></path></svg>`,
                success: `<svg class="icon" viewBox="0 0 1024 1024"><path d="M512 64a448 448 0 1 0 0 896 448 448 0 0 0 0-896z m0 128c176.736 0 320 143.264 320 320s-143.264 320-320 320S192 728.736 192 512 335.264 192 512 192z m-146.88 233.12L456.32 656.8l257.76-257.76-45.248-45.248-212.512 212.512-91.2-91.2-45.248 45.248z"></path></svg>`,
                warning: `<svg class="icon" viewBox="0 0 1024 1024"><path d="M512 64a448 448 0 1 0 0 896 448 448 0 0 0 0-896z m0 128c176.736 0 320 143.264 320 320s-143.264 320-320 320S192 728.736 192 512 335.264 192 512 192z m-32 160v192h64V352h-64z m0 256v64h64v-64h-64z"></path></svg>`,
                preview: `<svg class="icon" viewBox="0 0 1024 1024"><path d="M512 128c-293.824 0-512 238.176-512 512s218.176 512 512 512 512-238.176 512-512-218.176-512-512-512z m0 896c-212.064 0-384-171.936-384-384s171.936-384 384-384 384 171.936 384 384-171.936 384-384 384z m0-576c-106.048 0-192 85.952-192 192s85.952 192 192 192 192-85.952 192-192-85.952-192-192-192z m0 256c-35.328 0-64-28.672-64-64s28.672-64 64-64 64 28.672 64 64-28.672 64-64 64z"></path></svg>`,
                copy: `<svg class="icon" viewBox="0 0 1024 1024"><path d="M704 128H192c-35.2 0-64 28.8-64 64v576c0 35.2 28.8 64 64 64h512c35.2 0 64-28.8 64-64V192c0-35.2-28.8-64-64-64z m0 640H192V192h512v576z m128-128c0 35.2-28.8 64-64 64h-64v-64h64V256H320v64h-64V256c0-35.2 28.8-64 64-64h512c35.2 0 64 28.8 64 64v512z"></path></svg>`,
                spinner: `<svg class="icon" viewBox="0 0 1024 1024" class="animate-spin"><path d="M512 128c-212.064 0-384 171.936-384 384h64c0-176.736 143.264-320 320-320s320 143.264 320 320 143.264 320 320 320c-176.736 0-320-143.264-320-320h-64c0 212.064 171.936 384 384 384s384-171.936 384-384-171.936-384-384-384z"></path></svg>`
            };

            // --- 2. State Management ---
            const state = {
                isCopying: false,
                isFullScreen: false,
                currentTheme: CONFIG.DEFAULT_THEME,
                content: '',
                domCache: {}
            };

            // --- 3. Modules ---
            
            /**
             * UI Module: Handles all DOM interactions and updates.
             */
            const UI = {
                init() {
                    this.cacheDOM();
                    this.injectIcons();
                    this.renderThemeButtons();
                    this.updateThemeSelection();
                },
                cacheDOM() {
                    state.domCache = {
                        body: document.body,
                        markdownInput: document.getElementById('markdown-input'),
                        previewOutput: document.getElementById('preview-output'),
                        themeButtonsContainer: document.getElementById('theme-buttons'),
                        editorControls: document.getElementById('editor-controls'),
                        previewControls: document.getElementById('preview-controls'),
                        editorToolbar: document.getElementById('editor-toolbar'),
                        fileInput: document.getElementById('file-input'),
                        toast: document.getElementById('toast'),
                        modalContainer: document.getElementById('modal-container')
                    };
                },
                injectIcons() {
                    document.querySelectorAll('[data-action]').forEach(el => {
                        const action = el.dataset.action;
                        if (ICONS[action]) el.querySelector('span').innerHTML = ICONS[action];
                    });
                    document.querySelectorAll('.toolbar-button').forEach(el => {
                        const type = el.dataset.type;
                        if (ICONS[type]) el.querySelector('span').innerHTML = ICONS[type];
                    })
                },
                renderThemeButtons() {
                    state.domCache.themeButtonsContainer.innerHTML = Object.entries(THEMES)
                        .map(([key, name]) => `<button class="theme-button" data-theme="${key}" aria-label="切换到${name}主题">${name}</button>`)
                        .join('');
                },
                updateThemeSelection() {
                    state.domCache.themeButtonsContainer.querySelectorAll('.theme-button').forEach(btn => {
                        btn.classList.toggle('selected', btn.dataset.theme === state.currentTheme);
                    });
                    state.domCache.previewOutput.className = `theme-${state.currentTheme}`;
                },
                toggleFullScreen() {
                    state.isFullScreen = !state.isFullScreen;
                    state.domCache.body.classList.toggle('fullscreen-mode', state.isFullScreen);
                    const btn = state.domCache.editorControls.querySelector('[data-action="fullscreen"]');
                    btn.querySelector('span').innerHTML = state.isFullScreen ? ICONS.compress : ICONS.fullscreen;
                    btn.setAttribute('aria-label', state.isFullScreen ? '退出全屏' : '切换全屏模式');
                },
                setCopyButtonState(isCopying) {
                    const btn = state.domCache.previewControls.querySelector('[data-action="copy"]');
                    btn.disabled = isCopying;
                    if (isCopying) {
                        btn.innerHTML = `${ICONS.spinner} 优化中...`;
                    } else {
                        btn.innerHTML = `${ICONS.copy} 复制排版`;
                    }
                },
                showToast(message) {
                    const el = state.domCache.toast;
                    el.textContent = message;
                    el.classList.add('show');
                    setTimeout(() => el.classList.remove('show'), 3000);
                },
                showConfirmModal(title, message, onConfirm) {
                    const modalId = `modal-${Date.now()}`;
                    const modalHTML = `
                        <div id="${modalId}" class="modal-overlay show">
                            <div class="modal-content">
                                <div class="modal-header"><h3 class="modal-title">${title}</h3></div>
                                <div class="modal-body"><p>${message}</p></div>
                                <div class="modal-footer">
                                    <button class="btn-secondary" data-dismiss>取消</button>
                                    <button class="btn-danger" data-confirm>确认</button>
                                </div>
                            </div>
                        </div>`;
                    state.domCache.modalContainer.insertAdjacentHTML('beforeend', modalHTML);
                    const modalEl = document.getElementById(modalId);
                    modalEl.addEventListener('click', e => {
                        if (e.target.hasAttribute('data-dismiss')) modalEl.remove();
                        if (e.target.hasAttribute('data-confirm')) {
                            onConfirm();
                            modalEl.remove();
                        }
                    });
                },
                showWechatPreview(html) {
                    const modalId = `modal-preview-${Date.now()}`;
                    const modalHTML = `
                        <div id="${modalId}" class="modal-overlay show">
                            <div class="wechat-preview-content">
                                <div class="wechat-modal-header">
                                    <div class="wechat-modal-title">微信编辑器预览</div>
                                    <button class="wechat-modal-close" data-dismiss>&times;</button>
                                </div>
                                <div class="wechat-modal-body">${html}</div>
                                <div class="wechat-modal-footer"><p>这是在微信编辑器中的最终效果</p></div>
                            </div>
                        </div>`;
                    state.domCache.modalContainer.insertAdjacentHTML('beforeend', modalHTML);
                    const modalEl = document.getElementById(modalId);
                    modalEl.querySelector('[data-dismiss]').addEventListener('click', () => modalEl.remove());
                },
                 showCopySuccessMessage() {
                    if (document.querySelector('.copy-success-tip')) return;
                    const successTip = document.createElement('div');
                    successTip.className = 'copy-success-tip';
                    successTip.innerHTML = `
                        <div class="success-icon">${ICONS.success}</div>
                        <div class="success-text">
                            <h4>复制成功！</h4>
                            <p>已自动优化排版与代码高亮</p>
                            <p style="font-size: 13px; opacity: 0.9; margin-top: 10px; color: #fde047;">提示：若文章含图片，粘贴后请手动上传。</p>
                        </div>`;
                    document.body.appendChild(successTip);
                    setTimeout(() => document.body.removeChild(successTip), 4000);
                }
            };

            /**
             * MarkdownProcessor Module: Handles Markdown to HTML conversion.
             */
            const MarkdownProcessor = {
                init() {
                    marked.setOptions({
                        headerIds: false, gfm: true, breaks: true, sanitize: false,
                        highlight: (code, lang) => {
                            const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                            return hljs.highlight(code, { language }).value;
                        }
                    });
                },
                render(markdownText) {
                    const rawHtml = marked.parse(markdownText);
                    const doc = new DOMParser().parseFromString(rawHtml, 'text/html');
                    // Process custom blocks
                    doc.querySelectorAll('blockquote').forEach(quote => {
                        const firstP = quote.querySelector('p');
                        if (!firstP) return;
                        const content = firstP.innerHTML.trim();
                        let blockType = null, marker = '';
                        if (content.startsWith('!')) { blockType = 'intro'; marker = '!'; }
                        else if (content.startsWith('?')) { blockType = 'tip'; marker = '?'; }
                        else if (content.startsWith('√')) { blockType = 'success'; marker = '√'; }
                        else if (content.startsWith('x')) { blockType = 'warning'; marker = 'x'; }
                        
                        if (blockType) {
                            firstP.innerHTML = content.substring(marker.length).trim();
                            const section = document.createElement('section');
                            section.className = `custom-block ${blockType}`;
                            section.innerHTML = quote.innerHTML;
                            quote.parentNode.replaceChild(section, quote);
                        }
                    });
                    state.domCache.previewOutput.innerHTML = doc.body.innerHTML;
                }
            };

            /**
             * StyleEngine Module: The core of V12. Recursively computes and inlines
             * all necessary styles for perfect WeChat compatibility.
             */
            const StyleEngine = {
                // 样式缓存，避免重复计算
                _styleCache: new Map(),

                // 智能样式去重与内联
                inlineStyles(el, baseStyles = {}) {
                    if (!el || el.nodeType !== 1) return;
                    const computed = window.getComputedStyle(el);
                    let styleStr = '';
                    for (let key in baseStyles) {
                        if (computed[key] !== baseStyles[key]) {
                            styleStr += `${key}:${computed[key]};`;
                        }
                    }
                    // 去重：只添加变化的属性
                    el.setAttribute('style', styleStr);
                    // 递归处理子节点
                    Array.from(el.children).forEach(child => this.inlineStyles(child, baseStyles));
                },

                // 针对微信的特殊样式处理
                applyWechatCompat(el) {
                    if (!el) return;
                    // 图片自适应
                    el.querySelectorAll('img').forEach(img => {
                        img.style.maxWidth = '100%';
                        img.style.height = 'auto';
                        img.style.display = 'block';
                        img.style.margin = '1em auto';
                    });
                    // 表格兼容
                    el.querySelectorAll('table').forEach(table => {
                        table.style.width = '100%';
                        table.style.tableLayout = 'fixed';
                        table.style.wordBreak = 'break-all';
                        table.style.margin = '1em 0';
                    });
                    // 代码块兼容
                    el.querySelectorAll('pre, code').forEach(code => {
                        code.style.wordBreak = 'break-all';
                        code.style.whiteSpace = 'pre-wrap';
                        code.style.background = '#282c34';
                        code.style.borderRadius = '6px';
                        code.style.padding = '8px 12px';
                    });
                },

                formatForWeChat() {
                    return new Promise(resolve => {
                        requestIdleCallback(() => {
                            const clonedPreview = state.domCache.previewOutput.cloneNode(true);
                            clonedPreview.style.cssText = 'position:absolute; left:-9999px; width:' + state.domCache.previewOutput.clientWidth + 'px;';
                            document.body.appendChild(clonedPreview);

                            const rootBgColor = getComputedStyle(clonedPreview).backgroundColor;
                            const contentHtml = this.inlineStylesAndGetHtml(clonedPreview);
                            
                            const finalHtml = `<table style="width:100%; border-collapse: collapse; background-color:${rootBgColor};"><tbody><tr><td style="padding: 20px 15px;">${contentHtml}</td></tr></tbody></table>`;
                            
                            document.body.removeChild(clonedPreview);
                            resolve(finalHtml);
                        }, { timeout: 300 });
                    });
                },

                inlineStylesAndGetHtml(rootElement) {
                    const allElements = rootElement.querySelectorAll('*');
                    allElements.forEach(element => {
                        if (!element || typeof element.tagName === 'undefined') return;

                        const computedStyle = getComputedStyle(element);
                        let styleString = '';
                        
                        const propsToInline = [
                            'color', 'background-color', 'font-family', 'font-size', 'font-weight', 'font-style',
                            'line-height', 'letter-spacing', 'text-align', 'text-decoration',
                            'margin', 'padding',
                            'border', 'border-left', 'border-bottom', 'border-radius',
                            'display', 'vertical-align', 'opacity'
                        ];

                        propsToInline.forEach(prop => {
                            const value = computedStyle.getPropertyValue(prop);
                            // Only apply non-default values to keep the HTML clean
                            if (value && value !== '0px' && value !== 'rgba(0, 0, 0, 0)' && value !== 'none' && value !== 'normal') {
                                styleString += `${prop}:${value} !important;`;
                            }
                        });

                        // --- Smart Background Inheritance ---
                        const ownBg = computedStyle.getPropertyValue('background-color');
                        const rootBg = getComputedStyle(rootElement).backgroundColor;
                        if (ownBg === 'rgba(0, 0, 0, 0)' || ownBg === rootBg) {
                             styleString = styleString.replace(/background-color:[^;]+;/, '');
                             styleString += 'background-color: transparent !important;';
                        }
                        
                        // Specific fix for code blocks
                        if (element.tagName === 'CODE' && element.parentElement?.tagName === 'PRE') {
                            styleString += `background-color: transparent !important;`;
                        }

                        // --- Compatibility Overrides ---
                        styleString += 'box-sizing:border-box !important;';
                        // Use a smarter word-break strategy
                        if (['A', 'CODE'].includes(element.tagName)) {
                            styleString += 'word-wrap:break-word !important; word-break:break-all !important;';
                        } else {
                            styleString += 'word-wrap:break-word !important; line-break: strict !important;';
                        }
                        
                        if (element.tagName === 'TABLE') styleString += 'table-layout:fixed !important; width:100% !important; border-collapse:collapse !important;';
                        if (element.tagName === 'IMG') styleString += 'max-width:100% !important; height:auto !important;';
                        if (element.tagName === 'PRE') styleString += 'white-space:pre-wrap !important; overflow-x:auto;';

                        element.setAttribute('style', styleString);
                        element.removeAttribute('class');
                    });
                    return rootElement.innerHTML;
                }
            };

            // --- 4. Event Handlers & Main Logic ---
            const Handlers = {
                handleEditorInput: debounce(() => {
                    state.content = state.domCache.markdownInput.value;
                    MarkdownProcessor.render(state.content);
                    localStorage.setItem(CONFIG.LOCAL_STORAGE_KEY_CONTENT, state.content);
                }, CONFIG.DEBOUNCE_DELAY),

                handleThemeChange(e) {
                    const theme = e.target.closest('.theme-button')?.dataset.theme;
                    if (theme && theme !== state.currentTheme) {
                        state.currentTheme = theme;
                        UI.updateThemeSelection();
                        localStorage.setItem(CONFIG.LOCAL_STORAGE_KEY_THEME, theme);
                    }
                },

                handleEditorControls(e) {
                    const action = e.target.closest('button')?.dataset.action;
                    if (!action) return;
                    const actions = {
                        import: () => state.domCache.fileInput.click(),
                        export: this.exportFile,
                        fullscreen: UI.toggleFullScreen,
                        clear: () => UI.showConfirmModal('确认清空', '您确定要清空编辑器中的所有内容吗？此操作不可撤销。', this.clearEditor)
                    };
                    actions[action]?.();
                },

                handlePreviewControls: async function(e) {
                    const action = e.target.closest('button')?.dataset.action;
                    if (!action) return;
                    if (action === 'copy') await this.copyToClipboard();
                    if (action === 'preview-wechat') {
                        UI.setCopyButtonState(true);
                        const html = await StyleEngine.formatForWeChat();
                        UI.setCopyButtonState(false);
                        UI.showWechatPreview(html);
                    }
                },

                handleToolbar(e) {
                    const type = e.target.closest('.toolbar-button')?.dataset.type;
                    if (!type) return;
                    const markers = { intro: '>! ', tip: '>? ', success: '>√ ', warning: '>x ' };
                    this.insertAtCursor(markers[type] || '');
                },
                
                async copyToClipboard() {
                    if (state.isCopying) return;
                    state.isCopying = true;
                    UI.setCopyButtonState(true);
                    
                    try {
                        const formattedContent = await StyleEngine.formatForWeChat();
                        let success = false;

                        if (navigator.clipboard && navigator.clipboard.write) {
                            try {
                                await navigator.clipboard.write([new ClipboardItem({
                                    'text/html': new Blob([formattedContent], { type: 'text/html' }),
                                    'text/plain': new Blob([formattedContent.replace(/<[^>]*>/g, '')], { type: 'text/plain' })
                                })]);
                                success = true;
                            } catch (err) {
                                console.warn('Modern clipboard API failed, falling back to legacy method.', err);
                            }
                        }

                        if (!success) {
                            const tempEl = document.createElement('div');
                            tempEl.style.position = 'absolute';
                            tempEl.style.left = '-9999px';
                            document.body.appendChild(tempEl);
                            tempEl.innerHTML = formattedContent;
                            
                            const selection = window.getSelection();
                            const range = document.createRange();
                            range.selectNodeContents(tempEl);
                            selection.removeAllRanges();
                            selection.addRange(range);
                            
                            try {
                                if (!document.execCommand('copy')) {
                                    throw new Error('execCommand returned false');
                                }
                                success = true;
                            } finally {
                                selection.removeAllRanges();
                                document.body.removeChild(tempEl);
                            }
                        }
                        
                        if (success) {
                            UI.showCopySuccessMessage();
                        } else {
                            throw new Error("All clipboard methods failed.");
                        }

                    } catch (error) {
                        console.error('复制功能错误:', error);
                        UI.showToast('复制失败，请手动复制');
                    } finally {
                        state.isCopying = false;
                        UI.setCopyButtonState(false);
                    }
                },

                clearEditor() {
                    state.domCache.markdownInput.value = '';
                    Handlers.handleEditorInput(); // Trigger render and save
                    UI.showToast('内容已清空');
                },

                exportFile() {
                    const blob = new Blob([state.content], { type: 'text/markdown;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `wechat-article-${Date.now()}.md`;
                    a.click();
                    URL.revokeObjectURL(url);
                    UI.showToast('文件已导出');
                },

                handleFileSelect(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = e => {
                        state.domCache.markdownInput.value = e.target.result;
                        this.handleEditorInput();
                        UI.showToast('文件导入成功');
                    };
                    reader.onerror = () => UI.showToast('文件读取失败');
                    reader.readAsText(file);
                    event.target.value = '';
                },

                insertAtCursor(text) {
                    const { selectionStart, selectionEnd, value } = state.domCache.markdownInput;
                    state.domCache.markdownInput.value = value.substring(0, selectionStart) + text + value.substring(selectionEnd);
                    state.domCache.markdownInput.selectionEnd = selectionStart + text.length;
                    state.domCache.markdownInput.focus();
                    this.handleEditorInput();
                }
            };
            
            // --- 5. Initialization ---
            function init() {
                UI.init();
                MarkdownProcessor.init();

                // Load initial state
                state.content = localStorage.getItem(CONFIG.LOCAL_STORAGE_KEY_CONTENT) || CONFIG.SAMPLE_CONTENT;
                state.currentTheme = localStorage.getItem(CONFIG.LOCAL_STORAGE_KEY_THEME) || CONFIG.DEFAULT_THEME;
                state.domCache.markdownInput.value = state.content;
                
                UI.updateThemeSelection();
                MarkdownProcessor.render(state.content);
                
                // Setup event listeners using delegation
                state.domCache.markdownInput.addEventListener('input', Handlers.handleEditorInput.bind(Handlers));
                state.domCache.themeButtonsContainer.addEventListener('click', Handlers.handleThemeChange.bind(Handlers));
                state.domCache.editorControls.addEventListener('click', Handlers.handleEditorControls.bind(Handlers));
                state.domCache.previewControls.addEventListener('click', Handlers.handlePreviewControls.bind(Handlers));
                state.domCache.editorToolbar.addEventListener('click', Handlers.handleToolbar.bind(Handlers));
                state.domCache.fileInput.addEventListener('change', Handlers.handleFileSelect.bind(Handlers));
            }

            // --- Utility ---
            function debounce(func, delay) {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            }

            return { init };
        })();

        document.addEventListener('DOMContentLoaded', WeChatFormatterApp.init);
    </script>
</body>
</html>
