<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微信公众号Markdown格式化工具3.3 (最终修复版)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* 颜色变量 */
        :root {
            --primary-color: #3f51b5;
            --primary-dark: #303f9f;
            --secondary-color: #f5f5f5;
            --border-color: #e0e0e0;
            --text-color: #333;
            --text-light: #777;
            --success-color: #4caf50;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --background-color: #f8f9fa;
        }

        /* 全局样式 */
        body {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #1E293B;
            padding: 20px;
            margin: 0;
            box-sizing: border-box;
            font-size: 16px; /* Base font size */
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* 头部样式 */
        header {
            text-align: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        h1 {
            color: #CBD5E1;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #94A3B8;
            font-size: 1.2rem;
            max-width: 700px;
            margin: 0 auto;
        }

        /* 主要内容样式 */
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            height: calc(100vh - 200px);
        }

        .editor-container,
        .preview-container {
            flex: 1;
            min-width: 300px;
            background: #334155;
            border-radius: 10px;
            box-shadow: 0 4px 12px var(--shadow-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* 面板头部样式 */
        .panel-header {
            padding: 15px 20px;
            background: #475569;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-weight: 600;
            font-size: 1.2rem;
            color: #F9FAFB;
        }
        
        /* 编辑器工具栏样式 */
        .editor-toolbar {
            padding: 10px 15px;
            background: #475569;
            border-bottom: 1px solid #64748B;
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .toolbar-button {
            background: #64748B;
            color: #F1F5F9;
            border: none;
            border-radius: 5px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }
        .toolbar-button:hover {
            background: #94A3B8;
        }
        .toolbar-button i {
            margin-right: 5px;
        }

        /* 控制器样式 */
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        button {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 1rem;
            color: #F9FAFB;
        }

        .btn-primary {
            background: #4ADE80;
            color: #0F172A;
            box-shadow: 0 2px 5px var(--shadow-color);
        }

        .btn-primary:hover {
            background: #22C55E;
            box-shadow: 0 3px 7px var(--shadow-color);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border-color);
            color: #F9FAFB;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        /* 面板主体样式 */
        .panel-body {
            flex: 1;
            overflow: auto;
            position: relative;
        }

        #markdown-input {
            width: 100%;
            height: 100%;
            padding: 20px;
            border: none;
            outline: none;
            resize: none;
            font-family: Consolas, Monaco, monospace;
            font-size: 1rem;
            line-height: 1.6;
            color: #F9FAFB;
            background-color: transparent;
        }

        #preview-output {
            padding: 20px;
            overflow-y: auto;
            height: 100%;
            font-size: 1rem;
            color: #F9FAFB;
        }

        /* Toast 样式 */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success-color);
            color: #fff;
            padding: 12px 24px;
            border-radius: 30px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
        }

        /* Theme Button Styles */
        .theme-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: flex-start;
        }

        .theme-button {
            padding: 8px 16px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-size: 1rem;
            color: #F9FAFB;
            background-color: #475569;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
            min-width: 80px;
        }

        .theme-button:hover {
            background-color: #64748B;
            box-shadow: 0 3px 7px rgba(0, 0, 0, 0.1);
        }

        .theme-button.selected {
            background-color: #4ADE80;
            color: #0F172A;
        }

        /* --- 主题样式区 --- */
        .theme-default {
            --header-color: #1E40AF; --link-color: #3B82F6; --code-bg: #F3F4F6; --quote-border: #D1D5DB; --table-header: #F9FAFB; --table-border: #E5E7EB; --background-color: #FFFFFF; --text-color: #111827;
            --intro-bg: #EBF5FF; --intro-border: #3B82F6; --tip-bg: #EBF5FF; --tip-border: #3B82F6; --success-bg: #F0FFF4; --success-border: #48BB78; --warning-bg: #FFFBEB; --warning-border: #F59E0B;
        }
        .theme-green {
            --header-color: #047857; --link-color: #059669; --code-bg: #ECFDF5; --quote-border: #A7F3D0; --table-header: #ECFDF5; --table-border: #A7F3D0; --background-color: #FFFFFF; --text-color: #047857;
            --intro-bg: #ECFDF5; --intro-border: #059669; --tip-bg: #ECFDF5; --tip-border: #059669; --success-bg: #D1FAE5; --success-border: #10B981; --warning-bg: #FEF3C7; --warning-border: #D97706;
        }
        .theme-purple {
            --header-color: #7C3AED; --link-color: #8B5CF6; --code-bg: #F5F3FF; --quote-border: #C4B5FD; --table-header: #F5F3FF; --table-border: #C4B5FD; --background-color: #FFFFFF; --text-color: #7C3AED;
            --intro-bg: #F5F3FF; --intro-border: #8B5CF6; --tip-bg: #F5F3FF; --tip-border: #8B5CF6; --success-bg: #F0FDFA; --success-border: #2DD4BF; --warning-bg: #FEFCE8; --warning-border: #EAB308;
        }
        .theme-github {
            --header-color: #24292F; --link-color: #0969DA; --code-bg: #F6F8FA; --quote-border: #D0D7DE; --table-header: #F6F8FA; --table-border: #D0D7DE; --background-color: #FFFFFF; --text-color: #24292F;
            --intro-bg: #F6F8FA; --intro-border: #0969DA; --tip-bg: #F6F8FA; --tip-border: #0969DA; --success-bg: #E6FFED; --success-border: #28A745; --warning-bg: #FFFBDD; --warning-border: #B08800;
        }
        .theme-retro {
            --header-color: #B45309; --link-color: #D97706; --code-bg: #FEF3C7; --quote-border: #FCD34D; --table-header: #FEF3C7; --table-border: #FCD34D; --background-color: #FFFBEB; --text-color: #92400E;
            --intro-bg: #FEF3C7; --intro-border: #D97706; --tip-bg: #FEF3C7; --tip-border: #D97706; --success-bg: #F7FEE7; --success-border: #65A30D; --warning-bg: #FFF7ED; --warning-border: #FB923C;
        }
        .theme-sakura {
            --header-color: #BE185D; --link-color: #EC4899; --code-bg: #FDF2F8; --quote-border: #F9A8D4; --table-header: #FDF2F8; --table-border: #F9A8D4; --background-color: #FFFFFF; --text-color: #BE185D;
            --intro-bg: #FDF2F8; --intro-border: #EC4899; --tip-bg: #FDF2F8; --tip-border: #EC4899; --success-bg: #F0FDFA; --success-border: #14B8A6; --warning-bg: #FFFBEB; --warning-border: #F59E0B;
        }
        .theme-gold {
            --header-color: #A16207; --link-color: #CA8A04; --code-bg: #FEF9C3; --quote-border: #FDE047; --table-header: #FEF9C3; --table-border: #FDE047; --background-color: #FFFEF2; --text-color: #A16207;
            --intro-bg: #FEF9C3; --intro-border: #CA8A04; --tip-bg: #FEF9C3; --tip-border: #CA8A04; --success-bg: #F7FEE7; --success-border: #84CC16; --warning-bg: #FFF7ED; --warning-border: #F97316;
        }
        .theme-mint {
            --header-color: #059669; --link-color: #10B981; --code-bg: #ECFCCB; --quote-border: #BEF264; --table-header: #ECFCCB; --table-border: #BEF264; --background-color: #F7FEE7; --text-color: #059669;
            --intro-bg: #F0FDF4; --intro-border: #10B981; --tip-bg: #F0FDF4; --tip-border: #10B981; --success-bg: #D1FAE5; --success-border: #059669; --warning-bg: #FEFCE8; --warning-border: #EAB308;
        }
        .theme-cyberpunk {
            --header-color: #06FFA5; --link-color: #00D9FF; --code-bg: #0F0F23; --quote-border: #FF006E; --table-header: #0F0F23; --table-border: #FF006E; --background-color: #0A0A0A; --text-color: #06FFA5;
            --intro-bg: #0F0F23; --intro-border: #00D9FF; --tip-bg: #0F0F23; --tip-border: #00D9FF; --success-bg: #0F231A; --success-border: #06FFA5; --warning-bg: #230F1A; --warning-border: #FF006E;
        }
        .theme-dark {
            --header-color: #F9FAFB; --link-color: #60A5FA; --code-bg: #374151; --quote-border: #6B7280; --table-header: #374151; --table-border: #6B7280; --background-color: #111827; --text-color: #F9FAFB;
            --intro-bg: #1F2937; --intro-border: #60A5FA; --tip-bg: #1F2937; --tip-border: #60A5FA; --success-bg: #163324; --success-border: #34D399; --warning-bg: #332517; --warning-border: #FBBF24;
        }
        .theme-ocean {
            --header-color: #0369A1; --link-color: #0284C7; --code-bg: #E0F2FE; --quote-border: #7DD3FC; --table-header: #E0F2FE; --table-border: #7DD3FC; --background-color: #F0F9FF; --text-color: #0369A1;
            --intro-bg: #E0F2FE; --intro-border: #0284C7; --tip-bg: #E0F2FE; --tip-border: #0284C7; --success-bg: #EFF6FF; --success-border: #3B82F6; --warning-bg: #FEFCE8; --warning-border: #EAB308;
        }
        .theme-forest {
            --header-color: #166534; --link-color: #16A34A; --code-bg: #F0FDF4; --quote-border: #86EFAC; --table-header: #F0FDF4; --table-border: #86EFAC; --background-color: #F7FEE7; --text-color: #166534;
            --intro-bg: #DCFCE7; --intro-border: #16A34A; --tip-bg: #DCFCE7; --tip-border: #16A34A; --success-bg: #D1FAE5; --success-border: #059669; --warning-bg: #FEF3C7; --warning-border: #D97706;
        }
        .theme-minimal {
            --header-color: #374151; --link-color: #6B7280; --code-bg: #F9FAFB; --quote-border: #E5E7EB; --table-header: #F9FAFB; --table-border: #E5E7EB; --background-color: #FFFFFF; --text-color: #374151;
            --intro-bg: #F9FAFB; --intro-border: #6B7280; --tip-bg: #F9FAFB; --tip-border: #6B7280; --success-bg: #F0FDF4; --success-border: #16A34A; --warning-bg: #FEFCE8; --warning-border: #D97706;
        }

        /* 预览内容样式 */
        #preview-output {
            background-color: var(--background-color);
            color: var(--text-color);
        }

        /* --- 标题字号优化 (v3.1) --- */
        #preview-output h1, #preview-output h2, #preview-output h3, #preview-output h4, #preview-output h5, #preview-output h6 {
            color: var(--header-color); margin-top: 24px; margin-bottom: 16px; font-weight: bold; line-height: 1.4;
        }
        #preview-output h1 { font-size: 1.875rem; border-bottom: 2px solid var(--header-color); padding-bottom: 0.4em; } /* 30px */
        #preview-output h2 { font-size: 1.5rem; border-bottom: 1px solid var(--header-color); padding-bottom: 0.3em; }    /* 24px */
        #preview-output h3 { font-size: 1.25rem; }   /* 20px */
        #preview-output h4 { font-size: 1.125rem; }  /* 18px */
        #preview-output h5 { font-size: 1rem; }      /* 16px */
        #preview-output h6 { font-size: 0.875rem; color: var(--text-light, #777); } /* 14px */
        
        #preview-output p { margin: 16px 0; color: var(--text-color); }
        #preview-output a { color: var(--link-color); text-decoration: none; }
        #preview-output a:hover { text-decoration: underline; }
        #preview-output code { background-color: var(--code-bg); padding: 0.2em 0.4em; border-radius: 3px; font-family: Consolas, Monaco, monospace; font-size: 0.9em; color: var(--text-color); }
        #preview-output pre { background-color: var(--code-bg); padding: 16px; border-radius: 5px; overflow-x: auto; margin: 16px 0; }
        #preview-output pre code { background: none; padding: 0; }
        #preview-output blockquote { border-left: 4px solid var(--quote-border); padding-left: 16px; margin: 16px 0; color: var(--text-color); opacity: 0.8; }
        #preview-output ul, #preview-output ol { padding-left: 2em; margin: 16px 0; color: var(--text-color); }
        #preview-output li { margin-bottom: 8px; }
        #preview-output table { border-collapse: collapse; width: 100%; margin: 16px 0; color: var(--text-color); }
        #preview-output th, #preview-output td { border: 1px solid var(--table-border); padding: 8px 12px; text-align: left; }
        #preview-output th { background-color: var(--table-header); font-weight: bold; }
        #preview-output img { max-width: 100%; border-radius: 5px; margin: 16px 0; }
        #preview-output strong { color: var(--header-color); font-weight: bold; }
        #preview-output em { color: var(--link-color); font-style: italic; }

        /* 内容块通用样式 */
        .custom-block {
            padding: 16px; margin: 16px 0; border-left-width: 5px; border-left-style: solid; border-radius: 8px;
        }
        .custom-block p:first-child { margin-top: 0; }
        .custom-block p:last-child { margin-bottom: 0; }
        
        .custom-block.intro { background-color: var(--intro-bg); border-left-color: var(--intro-border); }
        .custom-block.tip { background-color: var(--tip-bg); border-left-color: var(--tip-border); }
        .custom-block.success { background-color: var(--success-bg); border-left-color: var(--success-border); }
        .custom-block.warning { background-color: var(--warning-bg); border-left-color: var(--warning-border); }

        /* 响应式布局 */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            h1 { font-size: 2rem; }
            .subtitle { font-size: 1rem; }
            .main-content { flex-direction: column; height: auto; }
            .editor-container, .preview-container { height: 50vh; }
            .panel-header { padding: 10px; flex-direction: column; gap: 10px; }
            .controls { width: 100%; justify-content: center; }
            .theme-buttons { justify-content: center; }
            .theme-button { padding: 6px 12px; min-width: 60px; font-size: 0.9rem; }
        }

        /* 复制成功提示样式 */
        .copy-success-tip { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(47, 129, 247, 0.95); color: #fff; border-radius: 12px; padding: 25px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3); z-index: 2000; display: flex; flex-direction: column; align-items: center; gap: 15px; animation: fadeInOut 3s ease-in-out; }
        .success-icon { font-size: 46px; color: #FFFFFF; }
        .success-text { text-align: center; }
        .success-text h4 { font-size: 22px; margin: 0 0 10px 0; color: #FFFFFF; }
        .success-text p { margin: 5px 0; opacity: 0.9; font-size: 16px; }
        @keyframes fadeInOut { 0% { opacity: 0; transform: translate(-50%, -60%); } 20% { opacity: 1; transform: translate(-50%, -50%); } 80% { opacity: 1; transform: translate(-50%, -50%); } 100% { opacity: 0; transform: translate(-50%, -50%); } }
        
        /* --- 2.0 功能块样式 --- */
        .wechat-preview-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 3000; display: flex; align-items: center; justify-content: center; }
        .wechat-preview-content { background-color: #f5f5f5; border-radius: 8px; width: 90%; max-width: 900px; max-height: 90vh; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column; }
        .wechat-modal-header { background-color: #07C160; color: #fff; padding: 15px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .wechat-modal-title { font-size: 18px; font-weight: bold; }
        .wechat-modal-close { background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; padding: 0; }
        .wechat-modal-body { overflow-y: auto; padding: 20px; background-color: #fff; flex-grow: 1; max-height: 70vh; }
        .wechat-modal-footer { background-color: #f5f5f5; padding: 15px; border-radius: 0 0 8px 8px; display: flex; justify-content: space-between; align-items: center; }
        .wechat-modal-footer p { margin: 0; color: #666; font-size: 14px; }
        .progress-bar { width: 100%; height: 10px; background-color: #f0f0f0; border-radius: 5px; overflow: hidden; }
        .progress { height: 100%; background-color: #4ADE80; border-radius: 5px; transition: width 0.5s ease-in-out; }
        kbd { background-color: #f7f7f7; border: 1px solid #ccc; border-radius: 3px; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2); color: #333; display: inline-block; font-size: 0.85em; font-family: monospace; line-height: 1; padding: 2px 4px; margin: 0 2px; }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>微信公众号 Markdown 格式化工具 3.3 (最终修复版)</h1>
            <p class="subtitle">将 Markdown 转换为微信公众号兼容的精美排版，支持多种主题和内容块，一键复制到公众号编辑器</p>
        </header>

        <div class="main-content">
            <div class="editor-container">
                <div class="panel-header">
                    <div class="panel-title">Markdown 编辑器</div>
                    <div class="controls">
                        <button id="clear-btn" class="btn-secondary">
                            <i class="fas fa-eraser"></i>
                            清空
                        </button>
                    </div>
                </div>
                <div class="editor-toolbar">
                    <button class="toolbar-button" data-type="intro"><i class="fas fa-quote-left"></i> 引言</button>
                    <button class="toolbar-button" data-type="tip"><i class="fas fa-info-circle"></i> 提示</button>
                    <button class="toolbar-button" data-type="success"><i class="fas fa-check-circle"></i> 成功</button>
                    <button class="toolbar-button" data-type="warning"><i class="fas fa-exclamation-triangle"></i> 警告</button>
                </div>
                <div class="panel-body">
                    <textarea id="markdown-input" placeholder="在此输入或粘贴 Markdown 内容..."></textarea>
                </div>
            </div>

            <div class="preview-container">
                <div class="panel-header">
                    <div class="panel-title">公众号预览</div>
                    <div class="controls">
                       <div class="theme-buttons">
                            <button class="theme-button selected" data-theme="default">默认</button>
                            <button class="theme-button" data-theme="green">绿意</button>
                            <button class="theme-button" data-theme="purple">姹紫</button>
                            <button class="theme-button" data-theme="github">GitHub</button>
                            <button class="theme-button" data-theme="retro">复古</button>
                            <button class="theme-button" data-theme="sakura">落樱</button>
                            <button class="theme-button" data-theme="gold">鎏金</button>
                            <button class="theme-button" data-theme="mint">薄荷</button>
                            <button class="theme-button" data-theme="cyberpunk">赛博</button>
                            <button class="theme-button" data-theme="dark">暗黑</button>
                            <button class="theme-button" data-theme="ocean">海洋</button>
                            <button class="theme-button" data-theme="forest">森林</button>
                            <button class="theme-button" data-theme="minimal">极简</button>
                        </div>
                        <button id="check-compatibility-btn" class="btn-secondary">
                            <i class="fas fa-check-circle"></i>
                            兼容性检测
                        </button>
                        <button id="preview-wechat-btn" class="btn-secondary">
                            <i class="fas fa-eye"></i>
                            微信预览
                        </button>
                        <button id="copy-btn" class="btn-primary">
                            <i class="fas fa-copy"></i>
                            复制排版
                        </button>
                    </div>
                </div>
                <div class="panel-body">
                    <div id="preview-output"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const markdownInput = document.getElementById('markdown-input');
        const previewOutput = document.getElementById('preview-output');
        const themeButtons = document.querySelectorAll('.theme-button');
        const clearBtn = document.getElementById('clear-btn');
        const copyBtn = document.getElementById('copy-btn');
        const toast = document.getElementById('toast');
        const editorToolbar = document.querySelector('.editor-toolbar');
        
        // --- 新增按钮引用 ---
        const previewWechatBtn = document.getElementById('preview-wechat-btn');
        const checkCompatibilityBtn = document.getElementById('check-compatibility-btn');


        const sampleContent = `# 文章主标题 (H1)
>! 这里是 **引言** 模块，用于概括文章核心内容，吸引读者继续阅读。

## 核心章节标题 (H2)
这是正文部分，我们建议使用 16px 的字号，以确保最佳的阅读体验。段落之间有足够的间距，行高设置为 1.6-1.75 之间。

### 小节标题 (H3)
当一个章节内容较多时，可以使用H3标题来划分不同的段落，使文章结构更加清晰。

#### 层次四标题 (H4)
对于更细分的层级，H4标题是一个很好的选择，它仅比正文稍大，起到温和的强调作用。

##### 层次五标题 (H5)
H5标题与正文大小相同，但通过加粗来区分。适合用于列表前的引题或注释。

###### 层次六标题 (H6)
H6是最小的标题，甚至比正文还小，非常适合用于图片下的注释、引用来源说明等场景。

>? **提示模块**
> 使用 \`>?\` 语法，分享一些小技巧或补充信息。

>√ **成功模块**
> 使用 \`>√\` 语法，展示积极的结果或正确范例。

>x **警告模块**
> 使用 \`>x\` 语法，强调需要特别注意的地方。
`;

        markdownInput.value = sampleContent;
        renderMarkdown();

        function renderMarkdown() {
            const markdownText = markdownInput.value;
            marked.setOptions({ headerIds: false, gfm: true, breaks: true, sanitize: false });
            
            let html = marked.parse(markdownText);
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            doc.querySelectorAll('blockquote').forEach(quote => {
                const firstP = quote.querySelector('p');
                if (!firstP) return;

                let content = firstP.innerHTML.trim();
                let blockType = null, marker = '';

                if (content.startsWith('!')) { blockType = 'intro'; marker = '!'; }
                else if (content.startsWith('?')) { blockType = 'tip'; marker = '?'; }
                else if (content.startsWith('√')) { blockType = 'success'; marker = '√'; }
                else if (content.startsWith('x')) { blockType = 'warning'; marker = 'x'; }

                if (blockType) {
                    firstP.innerHTML = content.substring(marker.length).trim();
                    const section = doc.createElement('section');
                    section.className = `custom-block ${blockType}`;
                    section.innerHTML = quote.innerHTML;
                    quote.parentNode.replaceChild(section, quote);
                }
            });
            previewOutput.innerHTML = doc.body.innerHTML;
        }

        function applyTheme(theme) {
            previewOutput.className = 'theme-' + theme;
            themeButtons.forEach(btn => btn.classList.remove('selected'));
            const targetButton = document.querySelector(`.theme-button[data-theme="${theme}"]`);
            if (targetButton) targetButton.classList.add('selected');
        }

        function copyToClipboard() {
            const formattedContent = prepareContentForCopy();
            const htmlBlob = new Blob([formattedContent], { type: 'text/html' });
            navigator.clipboard.write([new ClipboardItem({ 'text/html': htmlBlob })])
                .then(() => showCopySuccessMessage())
                .catch(err => {
                    console.error('复制失败:', err);
                    showToast('复制失败，您的浏览器可能不支持此操作');
                });
        }

        function prepareContentForCopy() {
            const tempPreview = document.createElement('div');
            tempPreview.className = previewOutput.className;
            document.body.appendChild(tempPreview);
            const themeStyles = getComputedStyle(tempPreview);

            const variables = {
                '--background-color': '#FFFFFF', '--text-color': '#111827',
                '--header-color': '#1E40AF', '--link-color': '#3B82F6',
                '--code-bg': '#F3F4F6', '--quote-border': '#D1D5DB',
                '--table-header': '#F9FAFB', '--table-border': '#E5E7EB',
                '--intro-bg': '#EBF5FF', '--intro-border': '#3B82F6',
                '--tip-bg': '#EBF5FF', '--tip-border': '#3B82F6',
                '--success-bg': '#F0FFF4', '--success-border': '#48BB78',
                '--warning-bg': '#FFFBEB', '--warning-border': '#F59E0B'
            };

            for (const key in variables) {
                variables[key] = themeStyles.getPropertyValue(key).trim() || variables[key];
            }
            
            document.body.removeChild(tempPreview);

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = previewOutput.innerHTML;

            const applyStyles = (elements, styleMap) => {
                elements.forEach(el => {
                    let styleString = '';
                    for (const prop in styleMap) {
                        styleString += `${prop}: ${styleMap[prop]}; `;
                    }
                    el.setAttribute('style', styleString);
                });
            };
            
            const finalHtml = `<section style="background-color:${variables['--background-color']}; color:${variables['--text-color']}; font-family:'Helvetica Neue', Helvetica, Arial, sans-serif; line-height:1.75; padding:20px 15px; font-size: 16px;">${tempDiv.innerHTML}</section>`;
            tempDiv.innerHTML = finalHtml;
            
            // --- 标题字号优化内联样式 ---
            const baseHeaderStyle = `color:${variables['--header-color']}; margin: 24px 0 16px 0; font-weight: bold; line-height: 1.4;`;
            applyStyles(tempDiv.querySelectorAll('h1'), { ...cssToJs(baseHeaderStyle), 'font-size': '30px', 'border-bottom': `2px solid ${variables['--header-color']}`, 'padding-bottom': '0.4em' });
            applyStyles(tempDiv.querySelectorAll('h2'), { ...cssToJs(baseHeaderStyle), 'font-size': '24px', 'border-bottom': `1px solid ${variables['--header-color']}`, 'padding-bottom': '0.3em' });
            applyStyles(tempDiv.querySelectorAll('h3'), { ...cssToJs(baseHeaderStyle), 'font-size': '20px' });
            applyStyles(tempDiv.querySelectorAll('h4'), { ...cssToJs(baseHeaderStyle), 'font-size': '18px' });
            applyStyles(tempDiv.querySelectorAll('h5'), { ...cssToJs(baseHeaderStyle), 'font-size': '16px' });
            applyStyles(tempDiv.querySelectorAll('h6'), { ...cssToJs(baseHeaderStyle), 'font-size': '14px', 'color': 'grey' });
            
            // FINAL FIX: Wrap header content in <strong> for robust bolding
            tempDiv.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach(heading => {
                // Prevent double-wrapping if content already contains <strong> (e.g., from sample markdown)
                if (!heading.innerHTML.trim().startsWith('<strong>')) {
                    heading.innerHTML = `<strong>${heading.innerHTML}</strong>`;
                }
            });

            // 内容块样式
            applyStyles(tempDiv.querySelectorAll('.custom-block.intro'), { 'background-color': variables['--intro-bg'], 'border-left': `5px solid ${variables['--intro-border']}`, 'padding': '16px', 'margin': '16px 0', 'border-radius': '8px' });
            applyStyles(tempDiv.querySelectorAll('.custom-block.tip'), { 'background-color': variables['--tip-bg'], 'border-left': `5px solid ${variables['--tip-border']}`, 'padding': '16px', 'margin': '16px 0', 'border-radius': '8px' });
            applyStyles(tempDiv.querySelectorAll('.custom-block.success'), { 'background-color': variables['--success-bg'], 'border-left': `5px solid ${variables['--success-border']}`, 'padding': '16px', 'margin': '16px 0', 'border-radius': '8px' });
            applyStyles(tempDiv.querySelectorAll('.custom-block.warning'), { 'background-color': variables['--warning-bg'], 'border-left': `5px solid ${variables['--warning-border']}`, 'padding': '16px', 'margin': '16px 0', 'border-radius': '8px' });

            // 其他元素
            applyStyles(tempDiv.querySelectorAll('p'), { 'margin': '16px 0', 'color': 'inherit', 'line-height': '1.75' });
            applyStyles(tempDiv.querySelectorAll('a'), { 'color': variables['--link-color'], 'text-decoration': 'none' });
            applyStyles(tempDiv.querySelectorAll('pre'), { 'background-color': variables['--code-bg'], 'padding': '16px', 'border-radius': '5px', 'overflow-x': 'auto', 'margin': '16px 0', 'white-space':'pre-wrap', 'word-break':'break-all' });
            applyStyles(tempDiv.querySelectorAll('blockquote'), { 'border-left': `4px solid ${variables['--quote-border']}`, 'padding-left': '16px', 'margin': '16px 0', 'color': 'inherit', 'opacity':'0.8' });
            applyStyles(tempDiv.querySelectorAll('table'), { 'border-collapse': 'collapse', 'width': '100%', 'margin': '16px 0', 'color': 'inherit' });
            tempDiv.querySelectorAll('th, td').forEach(cell => cell.setAttribute('style', `border: 1px solid ${variables['--table-border']}; padding: 8px 12px; text-align: left;`));
            tempDiv.querySelectorAll('th').forEach(th => th.style.backgroundColor = variables['--table-header']);
            applyStyles(tempDiv.querySelectorAll('strong'), { 'color': 'inherit', 'font-weight': 'bold' }); // Let strong inherit color from parent
            applyStyles(tempDiv.querySelectorAll('em'), { 'color': variables['--link-color'], 'font-style': 'italic' });
            
            return tempDiv.innerHTML;
        }

        function showCopySuccessMessage() {
            showToast('排版已成功复制！');
            if (document.querySelector('.copy-success-tip')) return;
            const successTip = document.createElement('div');
            successTip.className = 'copy-success-tip';
            successTip.innerHTML = `<div class="success-icon"><i class="fas fa-check-circle"></i></div><div class="success-text"><h4>复制成功！</h4><p>请直接粘贴到微信公众号编辑器</p></div>`;
            document.body.appendChild(successTip);
            setTimeout(() => document.body.removeChild(successTip), 3000);
        }

        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        editorToolbar.addEventListener('click', (e) => {
            const button = e.target.closest('.toolbar-button');
            if (!button) return;
            const markers = { intro: '>! ', tip: '>? ', success: '>√ ', warning: '>x ' };
            insertAtCursor(markers[button.dataset.type] || '');
        });

        function insertAtCursor(text) {
            const start = markdownInput.selectionStart;
            markdownInput.value = markdownInput.value.substring(0, start) + text + markdownInput.value.substring(markdownInput.selectionEnd);
            markdownInput.selectionEnd = start + text.length;
            markdownInput.focus();
            renderMarkdown();
        }
        
        function cssToJs(cssText) {
            const style = {};
            cssText.split(';').forEach(decl => {
                if (decl) {
                    const [prop, value] = decl.split(':');
                    const propName = prop.trim().replace(/-(\w)/g, (match, letter) => letter.toUpperCase());
                    style[propName] = value.trim();
                }
            });
            return style;
        }

        markdownInput.addEventListener('input', renderMarkdown);
        clearBtn.addEventListener('click', () => { markdownInput.value = ''; renderMarkdown(); });
        copyBtn.addEventListener('click', copyToClipboard);
        themeButtons.forEach(button => button.addEventListener('click', () => applyTheme(button.getAttribute('data-theme'))));

        applyTheme('default');
        
        // --- 2.0 功能块 JS ---
        function getFormattedContentForWechat() {
            const tempDiv = document.createElement('div');
            const styledContent = prepareContentForCopy();
            tempDiv.innerHTML = styledContent;
            return tempDiv.innerHTML;
        }

        function showWechatPreview() {
            const modal = document.createElement('div');
            modal.className = 'wechat-preview-modal';
            
            const previewContent = document.createElement('div');
            previewContent.className = 'wechat-preview-content';
            
            const modalHeader = document.createElement('div');
            modalHeader.className = 'wechat-modal-header';
            modalHeader.innerHTML = `
                <div class="wechat-modal-title">微信编辑器预览</div>
                <button class="wechat-modal-close">&times;</button>
            `;
            
            const modalBody = document.createElement('div');
            modalBody.className = 'wechat-modal-body';
            modalBody.innerHTML = getFormattedContentForWechat();

            const modalFooter = document.createElement('div');
            modalFooter.className = 'wechat-modal-footer';
            modalFooter.innerHTML = `
                <p>这是微信公众号编辑器中的预览效果，点击"复制排版"按钮可以将此格式复制到微信编辑器</p>
                <button class="btn-primary" id="close-preview">关闭预览</button>
            `;
            
            previewContent.appendChild(modalHeader);
            previewContent.appendChild(modalBody);
            previewContent.appendChild(modalFooter);
            modal.appendChild(previewContent);
            document.body.appendChild(modal);
            
            const closeModal = () => document.body.removeChild(modal);
            modal.querySelector('.wechat-modal-close').addEventListener('click', closeModal);
            modal.querySelector('#close-preview').addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        }

        function checkCompatibility() {
            const modal = document.createElement('div');
            modal.className = 'wechat-preview-modal';
            const previewContent = document.createElement('div');
            previewContent.className = 'wechat-preview-content';
            const modalHeader = document.createElement('div');
            modalHeader.className = 'wechat-modal-header';
            modalHeader.innerHTML = `
                <div class="wechat-modal-title">微信公众号兼容性检测</div>
                <button class="wechat-modal-close">&times;</button>
            `;
            const modalBody = document.createElement('div');
            modalBody.className = 'wechat-modal-body';
            
            const browserInfo = detectBrowser();
            const clipboardSupport = checkClipboardSupport();
            const richTextSupport = checkRichTextSupport();
            
            let compatibilityScore = 0;
            let recommendations = [];

            if (clipboardSupport.modern) compatibilityScore += 40;
            else if (clipboardSupport.legacy) {
                compatibilityScore += 20;
                recommendations.push('您的浏览器不支持现代剪贴板API，建议升级到最新版本的Chrome或Edge浏览器');
            } else {
                recommendations.push('您的浏览器不支持复制功能，请使用Chrome或Edge浏览器');
            }
            if (richTextSupport) compatibilityScore += 40;
            else recommendations.push('您的浏览器可能不支持富文本复制，可能导致样式丢失');

            if (browserInfo.name === 'Chrome' || browserInfo.name === 'Edge') {
                compatibilityScore += 20;
            } else {
                recommendations.push(`您正在使用 ${browserInfo.name} ${browserInfo.version}，建议使用Chrome或Edge以获得最佳体验`);
            }

            let compatibilityRating;
            if (compatibilityScore >= 80) compatibilityRating = '<span style="color:#4CAF50;font-weight:bold;">优秀</span>';
            else if (compatibilityScore >= 60) compatibilityRating = '<span style="color:#FFC107;font-weight:bold;">良好</span>';
            else if (compatibilityScore >= 40) compatibilityRating = '<span style="color:#FF9800;font-weight:bold;">一般</span>';
            else compatibilityRating = '<span style="color:#F44336;font-weight:bold;">较差</span>';

            modalBody.innerHTML = `
                <div style="margin-bottom:20px;">
                    <h3 style="margin-top:0;">兼容性评分: ${compatibilityRating}</h3>
                    <div class="progress-bar"><div class="progress" style="width:${compatibilityScore}%;"></div></div>
                    <p style="text-align:right;margin:5px 0 0 0;font-size:14px;">${compatibilityScore}/100</p>
                </div>
                <div style="margin-bottom:20px;">
                    <h4>浏览器信息</h4>
                    <ul>
                        <li>浏览器: ${browserInfo.name} ${browserInfo.version}</li>
                        <li>操作系统: ${browserInfo.os}</li>
                        <li>现代剪贴板API: ${clipboardSupport.modern ? '✅ 支持' : '❌ 不支持'}</li>
                        <li>传统复制命令: ${clipboardSupport.legacy ? '✅ 支持' : '❌ 不支持'}</li>
                        <li>富文本支持: ${richTextSupport ? '✅ 支持' : '❌ 可能不支持'}</li>
                    </ul>
                </div>
                ${recommendations.length > 0 ? `
                <div>
                    <h4>改进建议</h4>
                    <ul>${recommendations.map(rec => `<li>${rec}</li>`).join('')}</ul>
                </div>` : ''}
                <div style="margin-top:20px;padding-top:15px;border-top:1px solid #eee;">
                    <h4>复制技巧</h4>
                    <ul>
                        <li>使用键盘快捷键 <kbd>Ctrl</kbd>+<kbd>V</kbd> (Windows) 或 <kbd>⌘</kbd>+<kbd>V</kbd> (Mac) 粘贴可能会有更好的效果</li>
                        <li>如果粘贴后样式丢失，请尝试刷新页面后重新复制</li>
                    </ul>
                </div>
            `;
            
            const modalFooter = document.createElement('div');
            modalFooter.className = 'wechat-modal-footer';
            modalFooter.innerHTML = `<button class="btn-primary" id="close-compatibility">确定</button>`;
            
            previewContent.appendChild(modalHeader);
            previewContent.appendChild(modalBody);
            previewContent.appendChild(modalFooter);
            modal.appendChild(previewContent);
            document.body.appendChild(modal);

            const closeModal = () => document.body.removeChild(modal);
            modal.querySelector('.wechat-modal-close').addEventListener('click', closeModal);
            modal.querySelector('#close-compatibility').addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        }

        function detectBrowser() {
            const ua = navigator.userAgent;
            let browser = "未知", version = "未知", os = "未知";
            if (/windows/i.test(ua)) os = "Windows";
            else if (/macintosh|mac os x/i.test(ua)) os = "macOS";
            else if (/linux/i.test(ua)) os = "Linux";
            else if (/android/i.test(ua)) os = "Android";
            else if (/iphone|ipad|ipod/i.test(ua)) os = "iOS";

            let match;
            if ((match = ua.match(/(?:edg|edge|msie|firefox|chrome|safari)[\/: ]([\d.]+)/i))) {
                let name = match[0].toLowerCase();
                version = match[1];
                if (name.includes('edg') || name.includes('edge')) browser = 'Edge';
                else if (name.includes('chrome')) browser = 'Chrome';
                else if (name.includes('safari')) browser = 'Safari';
                else if (name.includes('firefox')) browser = 'Firefox';
                else if (name.includes('msie')) browser = 'Internet Explorer';
            }
            return { name: browser, version: version, os: os };
        }

        function checkClipboardSupport() {
            return {
                modern: !!(navigator.clipboard && navigator.clipboard.write),
                legacy: document.queryCommandSupported && document.queryCommandSupported('copy')
            };
        }

        function checkRichTextSupport() {
            return 'ClipboardItem' in window;
        }

        previewWechatBtn.addEventListener('click', showWechatPreview);
        checkCompatibilityBtn.addEventListener('click', checkCompatibility);

    </script>
</body>
</html>