<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微信公众号Markdown格式化工具(5.5最佳实践优化版)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* ========================================
         * 微信编辑器格式化工具 - 最佳实践优化版
         * 版本: 5.5 最佳实践优化版
         * 优化内容: 微信兼容性、代码结构、性能优化
         * ======================================== */
        
        /* 颜色变量 - 微信兼容优化 */
        :root {
            --primary-color: #3f51b5;
            --primary-dark: #303f9f;
            --secondary-color: #f5f5f5;
            --border-color: #e0e0e0;
            --text-color: #333;
            --text-light: #777;
            --success-color: #4caf50;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --background-color: #f8f9fa;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* 微信兼容字体设置 - 优先使用系统字体 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei UI", "Microsoft YaHei", Arial, sans-serif;
            line-height: 1.6;
            background-color: #1E293B;
            padding: 20px;
            font-size: 16px;
            /* 微信兼容性优化 */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: calc(100vh - 40px);
        }

        header {
            text-align: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        h1 {
            color: #CBD5E1;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #94A3B8;
            font-size: 1.2rem;
            max-width: 700px;
            margin: 0 auto;
        }

        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            flex-grow: 1;
            min-height: 400px;
        }

        /* 容器样式 - 微信兼容优化 */
        .editor-container,
        .preview-container {
            flex: 1;
            min-width: 300px;
            background: #334155;
            border-radius: 10px;
            /* 微信兼容性：使用border替代box-shadow */
            border: 1px solid #475569;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .panel-header {
            padding: 15px 20px;
            background: #475569;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .panel-title {
            font-weight: 600;
            font-size: 1.2rem;
            color: #F9FAFB;
        }

        .editor-toolbar {
            padding: 10px 15px;
            background: #475569;
            border-bottom: 1px solid #64748B;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .toolbar-button {
            background: #64748B;
            color: #F1F5F9;
            border: none;
            border-radius: 5px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }

        .toolbar-button:hover {
            background: #94A3B8;
        }

        .toolbar-button i {
            margin-right: 5px;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 1rem;
            color: #F9FAFB;
        }

        .btn-primary {
            background: #4ADE80;
            color: #0F172A;
        }

        .btn-primary:hover {
            background: #22C55E;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border-color);
            color: #F9FAFB;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .panel-body {
            flex: 1;
            overflow: auto;
            position: relative;
        }

        #markdown-input {
            width: 100%;
            height: 100%;
            padding: 20px;
            border: none;
            outline: none;
            resize: none;
            font-family: Consolas, Monaco, monospace;
            font-size: 1rem;
            line-height: 1.6;
            color: #F9FAFB;
            background-color: #334155;
        }

        #preview-output {
            padding: 20px;
            overflow-y: auto;
            height: 100%;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success-color);
            color: #fff;
            padding: 12px 24px;
            border-radius: 30px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
        }

        .theme-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: flex-start;
        }

        .theme-button {
            padding: 8px 16px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-size: 1rem;
            color: #F9FAFB;
            background-color: #475569;
            text-align: center;
            min-width: 80px;
        }

        .theme-button:hover {
            background-color: #64748B;
        }

        .theme-button.selected {
            background-color: #4ADE80;
            color: #0F172A;
        }

        /* --- 主题样式区 (新增 --highlight-color) --- */
        .theme-default {
            --header-color: #1E40AF;
            --link-color: #3B82F6;
            --code-bg: #F3F4F6;
            --quote-border: #D1D5DB;
            --table-header: #F9FAFB;
            --table-border: #E5E7EB;
            --background-color: #FFFFFF;
            --text-color: #111827;
            --intro-bg: #EBF5FF;
            --intro-border: #3B82F6;
            --tip-bg: #EBF5FF;
            --tip-border: #3B82F6;
            --success-bg: #F0FFF4;
            --success-border: #48BB78;
            --warning-bg: #FFFBEB;
            --warning-border: #F59E0B;
            --text-light: #777;
            --highlight-color: #111827;
        }

        .theme-green {
            --header-color: #047857;
            --link-color: #059669;
            --code-bg: #ECFDF5;
            --quote-border: #A7F3D0;
            --table-header: #ECFDF5;
            --table-border: #A7F3D0;
            --background-color: #FFFFFF;
            --text-color: #047857;
            --intro-bg: #ECFDF5;
            --intro-border: #059669;
            --tip-bg: #ECFDF5;
            --tip-border: #059669;
            --success-bg: #D1FAE5;
            --success-border: #10B981;
            --warning-bg: #FEF3C7;
            --warning-border: #D97706;
            --text-light: #4F8B70;
            --highlight-color: #047857;
        }

        .theme-purple {
            --header-color: #7C3AED;
            --link-color: #8B5CF6;
            --code-bg: #F5F3FF;
            --quote-border: #C4B5FD;
            --table-header: #F5F3FF;
            --table-border: #C4B5FD;
            --background-color: #FFFFFF;
            --text-color: #7C3AED;
            --intro-bg: #F5F3FF;
            --intro-border: #8B5CF6;
            --tip-bg: #F5F3FF;
            --tip-border: #8B5CF6;
            --success-bg: #F0FDFA;
            --success-border: #2DD4BF;
            --warning-bg: #FEFCE8;
            --warning-border: #EAB308;
            --text-light: #A57CDA;
            --highlight-color: #7C3AED;
        }

        .theme-github {
            --header-color: #24292F;
            --link-color: #0969DA;
            --code-bg: #F6F8FA;
            --quote-border: #D0D7DE;
            --table-header: #F6F8FA;
            --table-border: #D0D7DE;
            --background-color: #FFFFFF;
            --text-color: #24292F;
            --intro-bg: #F6F8FA;
            --intro-border: #0969DA;
            --tip-bg: #F6F8FA;
            --tip-border: #0969DA;
            --success-bg: #E6FFED;
            --success-border: #28A745;
            --warning-bg: #FFFBDD;
            --warning-border: #B08800;
            --text-light: #586069;
            --highlight-color: #24292F;
        }

        .theme-retro {
            --header-color: #B45309;
            --link-color: #D97706;
            --code-bg: #FEF3C7;
            --quote-border: #FCD34D;
            --table-header: #FEF3C7;
            --table-border: #FCD34D;
            --background-color: #FFFBEB;
            --text-color: #92400E;
            --intro-bg: #FEF3C7;
            --intro-border: #D97706;
            --tip-bg: #FEF3C7;
            --tip-border: #D97706;
            --success-bg: #F7FEE7;
            --success-border: #65A30D;
            --warning-bg: #FFF7ED;
            --warning-border: #FB923C;
            --text-light: #D97706;
            --highlight-color: #B45309;
        }

        .theme-sakura {
            --header-color: #BE185D;
            --link-color: #EC4899;
            --code-bg: #FDF2F8;
            --quote-border: #F9A8D4;
            --table-header: #FDF2F8;
            --table-border: #F9A8D4;
            --background-color: #FFFFFF;
            --text-color: #BE185D;
            --intro-bg: #FDF2F8;
            --intro-border: #EC4899;
            --tip-bg: #FDF2F8;
            --tip-border: #EC4899;
            --success-bg: #F0FDFA;
            --success-border: #14B8A6;
            --warning-bg: #FFFBEB;
            --warning-border: #F59E0B;
            --text-light: #F7B5D6;
            --highlight-color: #BE185D;
        }

        .theme-gold {
            --header-color: #A16207;
            --link-color: #CA8A04;
            --code-bg: #FEF9C3;
            --quote-border: #FDE047;
            --table-header: #FEF9C3;
            --table-border: #FDE047;
            --background-color: #FFFEF2;
            --text-color: #A16207;
            --intro-bg: #FEF9C3;
            --intro-border: #CA8A04;
            --tip-bg: #FEF9C3;
            --tip-border: #CA8A04;
            --success-bg: #F7FEE7;
            --success-border: #84CC16;
            --warning-bg: #FFF7ED;
            --warning-border: #F97316;
            --text-light: #B88A00;
            --highlight-color: #A16207;
        }

        .theme-mint {
            --header-color: #059669;
            --link-color: #10B981;
            --code-bg: #ECFCCB;
            --quote-border: #BEF264;
            --table-header: #ECFCCB;
            --table-border: #BEF264;
            --background-color: #F7FEE7;
            --text-color: #059669;
            --intro-bg: #F0FDF4;
            --intro-border: #10B981;
            --tip-bg: #F0FDF4;
            --tip-border: #10B981;
            --success-bg: #D1FAE5;
            --success-border: #059669;
            --warning-bg: #FEFCE8;
            --warning-border: #EAB308;
            --text-light: #6EE7B7;
            --highlight-color: #059669;
        }

        .theme-cyberpunk {
            --header-color: #06FFA5;
            --link-color: #00D9FF;
            --code-bg: #0F0F23;
            --quote-border: #FF006E;
            --table-header: #0F0F23;
            --table-border: #FF006E;
            --background-color: #0A0A0A;
            --text-color: #06FFA5;
            --intro-bg: #0F0F23;
            --intro-border: #00D9FF;
            --tip-bg: #0F0F23;
            --tip-border: #00D9FF;
            --success-bg: #0F231A;
            --success-border: #06FFA5;
            --warning-bg: #230F1A;
            --warning-border: #FF006E;
            --text-light: #00FFFF;
            --highlight-color: #FFFFFF;
        }

        .theme-dark {
            --header-color: #F9FAFB;
            --link-color: #60A5FA;
            --code-bg: #374151;
            --quote-border: #6B7280;
            --table-header: #374151;
            --table-border: #6B7280;
            --background-color: #111827;
            --text-color: #F9FAFB;
            --intro-bg: #1F2937;
            --intro-border: #60A5FA;
            --tip-bg: #1F2937;
            --tip-border: #60A5FA;
            --success-bg: #163324;
            --success-border: #34D399;
            --warning-bg: #332517;
            --warning-border: #FBBF24;
            --text-light: #9CA3AF;
            --highlight-color: #FFFFFF;
        }

        .theme-ocean {
            --header-color: #0369A1;
            --link-color: #0284C7;
            --code-bg: #E0F2FE;
            --quote-border: #7DD3FC;
            --table-header: #E0F2FE;
            --table-border: #7DD3FC;
            --background-color: #F0F9FF;
            --text-color: #0369A1;
            --intro-bg: #E0F2FE;
            --intro-border: #0284C7;
            --tip-bg: #E0F2FE;
            --tip-border: #0284C7;
            --success-bg: #EFF6FF;
            --success-border: #3B82F6;
            --warning-bg: #FEFCE8;
            --warning-border: #EAB308;
            --text-light: #60A5FA;
            --highlight-color: #0369A1;
        }

        .theme-forest {
            --header-color: #166534;
            --link-color: #16A34A;
            --code-bg: #F0FDF4;
            --quote-border: #86EFAC;
            --table-header: #F0FDF4;
            --table-border: #86EFAC;
            --background-color: #F7FEE7;
            --text-color: #166534;
            --intro-bg: #DCFCE7;
            --intro-border: #16A34A;
            --tip-bg: #DCFCE7;
            --tip-border: #16A34A;
            --success-bg: #D1FAE5;
            --success-border: #059669;
            --warning-bg: #FEF3C7;
            --warning-border: #D97706;
            --text-light: #4ADE80;
            --highlight-color: #166534;
        }

        .theme-minimal {
            --header-color: #374151;
            --link-color: #6B7280;
            --code-bg: #F9FAFB;
            --quote-border: #E5E7EB;
            --table-header: #F9FAFB;
            --table-border: #E5E7EB;
            --background-color: #FFFFFF;
            --text-color: #374151;
            --intro-bg: #F9FAFB;
            --intro-border: #6B7280;
            --tip-bg: #F9FAFB;
            --tip-border: #6B7280;
            --success-bg: #F0FDF4;
            --success-border: #16A34A;
            --warning-bg: #FEFCE8;
            --warning-border: #D97706;
            --text-light: #888;
            --highlight-color: #111827;
        }

        .theme-serene-gray {
            --header-color: #111827;
            --link-color: #3b82f6;
            --code-bg: #f3f4f6;
            --quote-border: #6b7280;
            --table-header: #f9fafb;
            --table-border: #e5e7eb;
            --background-color: #ffffff;
            --text-color: #374151;
            --intro-bg: #f3f4f6;
            --intro-border: #d1d5db;
            --tip-bg: #eef2f9;
            --tip-border: #60a5fa;
            --success-bg: #f0fdf4;
            --success-border: #22c55e;
            --warning-bg: #fffbeb;
            --warning-border: #f59e0b;
            --text-light: #6b7280;
            --highlight-color: #111827;
        }

        .theme-warm-wood {
            --header-color: #854d0e;
            --link-color: #c2410c;
            --code-bg: #fefce8;
            --quote-border: #facc15;
            --table-header: #fefce8;
            --table-border: #f3eade;
            --background-color: #fdfbf8;
            --text-color: #78350f;
            --intro-bg: #fefce8;
            --intro-border: #facc15;
            --tip-bg: #fef9c3;
            --tip-border: #ca8a04;
            --success-bg: #f7fee7;
            --success-border: #65a30d;
            --warning-bg: #fff7ed;
            --warning-border: #fb923c;
            --text-light: #a16207;
            --highlight-color: #854d0e;
        }

        .theme-neumorphism {
            --header-color: #3b82f6;
            --link-color: #2563eb;
            --code-bg: #dbeafe;
            --quote-border: #bfdbfe;
            --table-header: #dbeafe;
            --table-border: #bfdbfe;
            --background-color: #eef2f9;
            --text-color: #475569;
            --intro-bg: #dbeafe;
            --intro-border: #93c5fd;
            --tip-bg: #e0e7ff;
            --tip-border: #818cf8;
            --success-bg: #dcfce7;
            --success-border: #4ade80;
            --warning-bg: #fef3c7;
            --warning-border: #facc15;
            --text-light: #64748b;
            --highlight-color: #2563eb;
        }

        .theme-ink-wash {
            --header-color: #1a1a1a;
            --link-color: #c82f2f;
            --code-bg: #f5f5f5;
            --quote-border: #cccccc;
            --table-header: #f5f5f5;
            --table-border: #e0e0e0;
            --background-color: #fcfcfc;
            --text-color: #2c2c2c;
            --intro-bg: #f5f5f5;
            --intro-border: #cccccc;
            --tip-bg: #f5f5f5;
            --tip-border: #cccccc;
            --success-bg: #f0f9f0;
            --success-border: #a0cda0;
            --warning-bg: #f9f0f0;
            --warning-border: #c82f2f;
            --text-light: #666666;
            --highlight-color: #c82f2f;
        }

        .theme-blueprint {
            --header-color: #2a6496;
            --link-color: #007bff;
            --code-bg: #e6f7ff;
            --quote-border: #a8d9ff;
            --table-header: #e6f7ff;
            --table-border: #a8d9ff;
            --background-color: #f8f9fa;
            --text-color: #2c3e50;
            --intro-bg: #e6f7ff;
            --intro-border: #a8d9ff;
            --tip-bg: #e6f7ff;
            --tip-border: #a8d9ff;
            --success-bg: #e6f7ff;
            --success-border: #a8d9ff;
            --warning-bg: #fff0e6;
            --warning-border: #ffb380;
            --text-light: #607d8b;
            --highlight-color: #007bff;
        }

        .theme-papyrus {
            --header-color: #4a3f2d;
            --link-color: #a52a2a;
            --code-bg: #f5efdb;
            --quote-border: #d3c0a5;
            --table-header: #f5efdb;
            --table-border: #d3c0a5;
            --background-color: #fdf6e3;
            --text-color: #584c2c;
            --intro-bg: #f5efdb;
            --intro-border: #d3c0a5;
            --tip-bg: #f5efdb;
            --tip-border: #d3c0a5;
            --success-bg: #e8f5e9;
            --success-border: #81c784;
            --warning-bg: #fff3e0;
            --warning-border: #ffb74d;
            --text-light: #8d6e63;
            --highlight-color: #a52a2a;
        }

        .theme-wechat-pro {
            --header-color: #07C160;
            --link-color: #576b95;
            --code-bg: #f7f7f7;
            --quote-border: #07C160;
            --table-header: #f7f7f7;
            --table-border: #e0e0e0;
            --background-color: #ffffff;
            --text-color: #333333;
            --intro-bg: #f7f7f7;
            --intro-border: #07C160;
            --tip-bg: #f7f7f7;
            --tip-border: #576b95;
            --success-bg: #f7f7f7;
            --success-border: #07C160;
            --warning-bg: #f7f7f7;
            --warning-border: #fa9d3b;
            --text-light: #888888;
            --highlight-color: #333333;
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei UI", "Microsoft YaHei", Arial, sans-serif;
            line-height: 1.75;
            padding: 1em;
            word-wrap: break-word;
        }

        .theme-org-minimal {
            --header-color: #222;
            --link-color: #007bff;
            --code-bg: #f5f5f5;
            --quote-border: #b3e690;
            --table-header: #f0f0f0;
            --table-border: #ddd;
            --background-color: #fff;
            --text-color: #333;
            --intro-bg: #f8f8f8;
            --intro-border: #b3e690;
            --tip-bg: #f8f8f8;
            --tip-border: #b3e690;
            --success-bg: #f8f8f8;
            --success-border: #b3e690;
            --warning-bg: #f8f8f8;
            --warning-border: #b3e690;
            --text-light: #555;
            --highlight-color: #111827;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            line-height: 1.8;
            padding: 1.5em;
            word-wrap: break-word;
        }

        /* 新增：学术风格主题 */
        .theme-academic {
            --header-color: #003366; /* 沉稳的深蓝色 */
            --link-color: #007BFF; /* 清晰的蓝色链接 */
            --code-bg: #F8F9FA; /* 浅灰色代码背景 */
            --quote-border: #6C757D; /* 中性灰色引用边框 */
            --table-header: #E9ECEF; /* 浅灰色表头 */
            --table-border: #DEE2E6; /* 标准表格边框色 */
            --background-color: #FFFFFF; /* 白色背景 */
            --text-color: #212529; /* 深灰色正文 */
            --intro-bg: #F8F9FA;
            --intro-border: #6C757D;
            --tip-bg: #E7F3FF; /* 提示背景 */
            --tip-border: #007BFF; /* 提示边框 */
            --success-bg: #D4EDDA; /* 成功背景 */
            --success-border: #28A745; /* 成功边框 */
            --warning-bg: #FFF3CD; /* 警告背景 */
            --warning-border: #FFC107; /* 警告边框 */
            --text-light: #6C757D; /* 浅色文字 */
            --highlight-color: #C00000; /* 红色，用于强调关键词 */
            font-family: 'Times New Roman', Times, serif; /* 衬线字体 */
            line-height: 1.8;
        }

        /* --- 精准高亮 CSS --- */
        #preview-output h1,
        #preview-output h2,
        #preview-output h3,
        #preview-output h4,
        #preview-output h5,
        #preview-output h6 {
            color: var(--header-color);
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: bold;
            line-height: 1.4;
        }

        #preview-output h1 {
            font-size: 1.875rem;
            border-bottom: 2px solid var(--header-color);
            padding-bottom: 0.4em;
        }

        #preview-output h2 {
            font-size: 1.5rem;
            border-bottom: 1px solid var(--header-color);
            padding-bottom: 0.3em;
        }

        #preview-output h3 {
            font-size: 1.25rem;
        }

        #preview-output h4 {
            font-size: 1.125rem;
        }

        #preview-output h5 {
            font-size: 1rem;
        }

        #preview-output h6 {
            font-size: 0.875rem;
            color: var(--text-light, #777);
        }

        #preview-output p {
            margin: 16px 0;
            color: var(--text-color);
            white-space: normal;
            word-break: normal;
            word-spacing: normal;
            overflow-wrap: break-word;
            text-rendering: optimizeLegibility;
            font-variant-ligatures: none;
            text-justify: auto;
        }

        #preview-output a {
            color: var(--link-color);
            text-decoration: none;
        }

        #preview-output a:hover {
            text-decoration: underline;
        }

        #preview-output code {
            background-color: var(--code-bg);
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: Consolas, Monaco, monospace;
            font-size: 0.9em;
            color: var(--text-color);
        }

        #preview-output pre {
            background-color: var(--code-bg);
            padding: 16px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 16px 0;
        }

        #preview-output pre code {
            background: none;
            padding: 0;
        }

        #preview-output blockquote {
            border-left: 4px solid var(--quote-border);
            padding-left: 16px;
            margin: 16px 0;
            color: var(--text-color);
            opacity: 0.8;
        }

        #preview-output ul,
        #preview-output ol {
            padding-left: 2em;
            margin: 16px 0;
            color: var(--text-color);
            white-space: normal;
            word-break: normal;
            word-spacing: normal;
            overflow-wrap: break-word;
            text-rendering: optimizeLegibility;
            font-variant-ligatures: none;
            text-justify: auto;
        }

        #preview-output li {
            margin-bottom: 8px;
            white-space: normal;
            word-break: normal;
            word-spacing: normal;
            overflow-wrap: break-word;
            text-rendering: optimizeLegibility;
            font-variant-ligatures: none;
            text-justify: auto;
        }

        #preview-output table {
            border-collapse: collapse;
            width: 100%;
            margin: 16px 0;
            color: var(--text-color);
        }

        #preview-output th,
        #preview-output td {
            border: 1px solid var(--table-border);
            padding: 8px 12px;
            text-align: left;
        }

        #preview-output th {
            background-color: var(--table-header);
            font-weight: bold;
        }

        #preview-output img {
            max-width: 100%;
            border-radius: 5px;
            margin: 16px 0;
        }

        #preview-output h1 strong,
        #preview-output h2 strong,
        #preview-output h3 strong,
        #preview-output h4 strong,
        #preview-output h5 strong,
        #preview-output h6 strong {
            color: inherit;
        }

        #preview-output strong {
            font-weight: bold;
            color: var(--highlight-color, #111827);
        }

        #preview-output em {
            color: var(--link-color);
            font-style: italic;
        }

        .custom-block {
            padding: 16px;
            margin: 16px 0;
            border-left-width: 5px;
            border-left-style: solid;
            border-radius: 8px;
        }

        .custom-block p:first-child {
            margin-top: 0;
        }

        .custom-block p:last-child {
            margin-bottom: 0;
        }

        .custom-block.intro {
            background-color: var(--intro-bg);
            border-left-color: var(--intro-border);
        }

        .custom-block.tip {
            background-color: var(--tip-bg);
            border-left-color: var(--tip-border);
        }

        .custom-block.success {
            background-color: var(--success-bg);
            border-left-color: var(--success-border);
        }

        .custom-block.warning {
            background-color: var(--warning-bg);
            border-left-color: var(--warning-border);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
                height: auto;
            }

            h1 {
                font-size: 2rem;
            }

            .subtitle {
                font-size: 1rem;
            }

            .main-content {
                flex-direction: column;
                height: auto;
                min-height: unset;
            }

            .editor-container,
            .preview-container {
                height: 50vh;
            }

            .panel-header {
                padding: 10px;
                flex-direction: column;
                gap: 10px;
            }

            .controls {
                width: 100%;
                justify-content: center;
            }

            .theme-buttons {
                justify-content: center;
            }

            .theme-button {
                padding: 6px 12px;
                min-width: 60px;
                font-size: 0.9rem;
            }

            .theme-org-minimal p {
                text-align: left;
            }
        }

        .copy-success-tip {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(47, 129, 247, 0.95);
            color: #fff;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            animation: fadeInOut 3s ease-in-out forwards;
        }

        .success-icon {
            font-size: 46px;
            color: #FFFFFF;
        }

        .success-text {
            text-align: center;
        }

        .success-text h4 {
            font-size: 22px;
            margin: 0 0 10px 0;
            color: #FFFFFF;
        }

        .success-text p {
            margin: 5px 0;
            opacity: 0.9;
            font-size: 16px;
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
                transform: translate(-50%, -60%);
            }

            20% {
                opacity: 1;
                transform: translate(-50%, -50%);
            }

            80% {
                opacity: 1;
                transform: translate(-50%, -50%);
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -40%);
            }
        }

        .wechat-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .wechat-preview-content {
            background-color: #f5f5f5;
            border-radius: 8px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .wechat-modal-header {
            background-color: #07C160;
            color: #fff;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .wechat-modal-title {
            font-size: 18px;
            font-weight: bold;
        }

        .wechat-modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
        }

        .wechat-modal-body {
            overflow-y: auto;
            padding: 20px;
            background-color: #fff;
            flex-grow: 1;
            max-height: 70vh;
        }

        .wechat-modal-footer {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 0 0 8px 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .wechat-modal-footer p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background-color: #4ADE80;
            border-radius: 5px;
            transition: width 0.5s ease-in-out;
        }

        /* 性能监控面板样式 */
        .performance-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 15px;
            color: #F9FAFB;
            font-size: 12px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            min-width: 200px;
            display: none;
        }

        .performance-panel.show {
            display: block;
        }

        .performance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .performance-close {
            background: none;
            border: none;
            color: #F9FAFB;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
        }

        .performance-metric {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 3px 0;
        }

        .performance-metric .label {
            color: #94A3B8;
        }

        .performance-metric .value {
            color: #4ADE80;
            font-weight: bold;
        }

        .performance-metric .value.slow {
            color: #F59E0B;
        }

        .performance-metric .value.fast {
            color: #22C55E;
        }

        kbd {
            background-color: #f7f7f7;
            border: 1px solid #ccc;
            border-radius: 3px;
            box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2);
            color: #333;
            display: inline-block;
            font-size: 0.85em;
            font-family: monospace;
            line-height: 1;
            padding: 2px 4px;
            margin: 0 2px;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>微信公众号 Markdown 格式化工具 6.0 (性能优化版)</h1>
            <p class="subtitle">将 Markdown 转换为微信公众号兼容的精美排版，按照微信编辑器最佳实践原则全面优化：智能缓存、批量处理、异步优化、性能监控、防抖机制，支持多种主题和内容块，一键复制到公众号编辑器</p>
        </header>

        <div class="main-content">
            <div class="editor-container">
                <div class="panel-header">
                    <div class="panel-title">Markdown 编辑器</div>
                    <div class="controls">
                        <button id="clear-btn" class="btn-secondary">
                            <i class="fas fa-eraser"></i>
                            清空
                        </button>
                    </div>
                </div>
                <div class="editor-toolbar">
                    <button class="toolbar-button" data-type="intro"><i class="fas fa-quote-left"></i> 引言</button>
                    <button class="toolbar-button" data-type="tip"><i class="fas fa-info-circle"></i> 提示</button>
                    <button class="toolbar-button" data-type="success"><i class="fas fa-check-circle"></i> 成功</button>
                    <button class="toolbar-button" data-type="warning"><i class="fas fa-exclamation-triangle"></i>
                        警告</button>
                </div>
                <div class="panel-body">
                    <textarea id="markdown-input" placeholder="在此输入或粘贴 Markdown 内容..."></textarea>
                </div>
            </div>

            <div class="preview-container">
                <div class="panel-header">
                    <div class="panel-title">公众号预览</div>
                    <div class="controls">
                        <div class="theme-buttons">
                            <button class="theme-button selected" data-theme="default">默认</button>
                            <button class="theme-button" data-theme="green">绿意</button>
                            <button class="theme-button" data-theme="purple">姹紫</button>
                            <button class="theme-button" data-theme="github">GitHub</button>
                            <button class="theme-button" data-theme="retro">复古</button>
                            <button class="theme-button" data-theme="sakura">落樱</button>
                            <button class="theme-button" data-theme="gold">鎏金</button>
                            <button class="theme-button" data-theme="mint">薄荷</button>
                            <button class="theme-button" data-theme="cyberpunk">赛博</button>
                            <button class="theme-button" data-theme="dark">暗黑</button>
                            <button class="theme-button" data-theme="ocean">海洋</button>
                            <button class="theme-button" data-theme="forest">森林</button>
                            <button class="theme-button" data-theme="minimal">极简</button>
                            <button class="theme-button" data-theme="serene-gray">静谧灰</button>
                            <button class="theme-button" data-theme="warm-wood">暖木棕</button>
                            <button class="theme-button" data-theme="neumorphism">新拟态</button>
                            <button class="theme-button" data-theme="ink-wash">水墨风</button>
                            <button class="theme-button" data-theme="blueprint">蓝图风</button>
                            <button class="theme-button" data-theme="papyrus">羊皮纸</button>
                            <button class="theme-button" data-theme="org-minimal">极简Org</button>
                            <button class="theme-button" data-theme="wechat-pro">微信专业版</button>
                            <button class="theme-button" data-theme="academic">学术风格</button>
                        </div>
                        <button id="check-compatibility-btn" class="btn-secondary">
                            <i class="fas fa-check-circle"></i>
                            兼容性检测
                        </button>
                        <button id="preview-wechat-btn" class="btn-secondary">
                            <i class="fas fa-eye"></i>
                            微信预览
                        </button>
                        <button id="copy-btn" class="btn-primary">
                            <i class="fas fa-copy"></i>
                            复制排版
                        </button>
                    </div>
                </div>
                <div class="panel-body">
                    <div id="preview-output"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>
    
    <!-- 性能监控面板 -->
    <div id="performance-panel" class="performance-panel">
        <div class="performance-header">
            <span>性能监控</span>
            <button class="performance-close" onclick="togglePerformancePanel()">&times;</button>
        </div>
        <div class="performance-metric">
            <span class="label">缓存命中率:</span>
            <span class="value" id="cache-hit-rate">0%</span>
        </div>
        <div class="performance-metric">
            <span class="label">平均处理时间:</span>
            <span class="value" id="avg-processing-time">0ms</span>
        </div>
        <div class="performance-metric">
            <span class="label">内存使用:</span>
            <span class="value" id="memory-usage">0KB</span>
        </div>
        <div class="performance-metric">
            <span class="label">优化状态:</span>
            <span class="value" id="optimization-status">正常</span>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const markdownInput = document.getElementById('markdown-input');
            const previewOutput = document.getElementById('preview-output');
            const themeButtons = document.querySelectorAll('.theme-button');
            const clearBtn = document.getElementById('clear-btn');
            const copyBtn = document.getElementById('copy-btn');
            const toast = document.getElementById('toast');
            const editorToolbar = document.querySelector('.editor-toolbar');
            const previewWechatBtn = document.getElementById('preview-wechat-btn');
            const checkCompatibilityBtn = document.getElementById('check-compatibility-btn');

            const sampleContent = `# 文章主标题
>! 这里是 **引言** 模块，用于概括文章核心内容，吸引读者继续阅读。

- 影响力潜力：9/10分。它直击行业核心痛点，解决方案兼具思想性（改变创作观念）和实用性（可直接复制使用），极易在目标社群中引发"自来水"式传播，分享率潜力巨大。
- 论证一致性：10/10分。Prompt内部逻辑严谨，从内核、原则到技术执行，层层递进，高度自洽。
- IP资产价值：9/10分。这篇**文章**和这个Prompt本身，都能成为你IP矩阵中的一个"高价值解决方案"，持续吸引精准粉丝。

## 核心章节标题与 **关键词**
这是正文部分，我们建议使用 **16px** 的字号，以确保最佳的阅读体验。段落之间有足够的间距，行高设置为 **1.6-1.75** 之间。

\`\`\`javascript
// 这是一个代码块示例
function greet(name) {
    console.log('Hello, ' + name + '!');
}
greet('World');
\`\`\`

| 优点 | 描述 |
| --- | --- |
| **结构化思维** | 将工程学思维引入Prompt设计，稳定性和可控性远超普通指令。|
| **高适应性** | 能处理任意长度的文本，并自动构思多种风格，适用范围极广。|
| **内置护城河** | 强大的负面词库极大提升了成品质量。|

`;

            markdownInput.value = sampleContent;

            function renderMarkdown() {
                const markdownText = markdownInput.value;
                marked.setOptions({ headerIds: false, gfm: true, breaks: true, sanitize: false });

                let html = marked.parse(markdownText);

                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                doc.querySelectorAll('blockquote').forEach(quote => {
                    const firstP = quote.querySelector('p');
                    if (!firstP) return;

                    let content = firstP.innerHTML.trim();
                    let blockType = null, marker = '';

                    if (content.startsWith('!')) { blockType = 'intro'; marker = '!'; }
                    else if (content.startsWith('?')) { blockType = 'tip'; marker = '?'; }
                    else if (content.startsWith('√')) { blockType = 'success'; marker = '√'; }
                    else if (content.startsWith('x')) { blockType = 'warning'; marker = 'x'; }

                    if (blockType) {
                        firstP.innerHTML = content.substring(marker.length).trim();
                        const section = doc.createElement('section');
                        section.className = `custom-block ${blockType}`;
                        section.innerHTML = quote.innerHTML;
                        quote.parentNode.replaceChild(section, quote);
                    }
                });
                previewOutput.innerHTML = doc.body.innerHTML;
                applyTheme(document.querySelector('.theme-button.selected')?.dataset.theme || 'default');
            }

            function applyTheme(theme) {
                previewOutput.className = 'theme-' + theme;

                document.querySelectorAll('.theme-button').forEach(btn => btn.classList.remove('selected'));
                const targetButton = document.querySelector(`.theme-button[data-theme="${theme}"]`);
                if (targetButton) targetButton.classList.add('selected');

                const tempDiv = document.createElement('div');
                tempDiv.className = 'theme-' + theme;
                document.body.appendChild(tempDiv);
                const computedStyle = getComputedStyle(tempDiv);

                // 应用主题的背景色和文字颜色到预览区域
                previewOutput.style.backgroundColor = computedStyle.getPropertyValue('--background-color');
                previewOutput.style.color = computedStyle.getPropertyValue('--text-color');

                // 对于 Org-minimal 主题，应用其特有的全局字体和行高
                if (theme === 'org-minimal') {
                    previewOutput.style.fontFamily = computedStyle.getPropertyValue('font-family');
                    previewOutput.style.lineHeight = computedStyle.getPropertyValue('line-height');
                    previewOutput.style.padding = computedStyle.getPropertyValue('padding');
                    previewOutput.style.wordWrap = computedStyle.getPropertyValue('word-wrap');
                } else {
                    // 恢复默认字体和行高
                    previewOutput.style.fontFamily = '';
                    previewOutput.style.lineHeight = '';
                    previewOutput.style.padding = '';
                    previewOutput.style.wordWrap = '';
                }

                document.body.removeChild(tempDiv);
            }

            // =================================================================
            // 复制功能 - 最佳实践优化版 V6.0
            // 功能: 将格式化内容复制到剪贴板
            // 优化: 现代API优先、错误处理、用户体验、防抖机制、性能优化
            // =================================================================
            
            // 防抖机制 - 防止重复点击
            let copyDebounceTimer = null;
            let isCopying = false;
            
            async function copyToClipboard() {
                // 防抖处理
                if (isCopying) {
                    showToast('正在处理中，请稍候...');
                    return;
                }
                
                if (copyDebounceTimer) {
                    clearTimeout(copyDebounceTimer);
                }
                
                copyDebounceTimer = setTimeout(async () => {
                    await performCopy();
                }, 100);
            }
            
            async function performCopy() {
                if (isCopying) return;
                
                isCopying = true;
                const startTime = performance.now();
                
                try {
                    // 显示加载状态
                    const originalText = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 优化中...';
                    copyBtn.disabled = true;
                    
                    // 异步准备格式化内容
                    const formattedContent = await prepareContentForCopyAsync();
                    
                    // 尝试使用现代剪贴板API
                    if (navigator.clipboard && navigator.clipboard.write) {
                        try {
                            await navigator.clipboard.write([
                                new ClipboardItem({
                                    'text/html': new Blob([formattedContent], { type: 'text/html' }),
                                    'text/plain': new Blob([formattedContent.replace(/<[^>]*>/g, '')], { type: 'text/plain' })
                                })
                            ]);
                            
                            const duration = performance.now() - startTime;
                            showCopySuccessMessage(duration);
                            return;
                        } catch (modernError) {
                            console.warn('现代剪贴板API失败，回退到传统方法:', modernError);
                        }
                    }
                    
                    // 回退到传统复制方法
                    await legacyCopyToClipboardAsync(formattedContent);
                    
                } catch (error) {
                    console.error('复制功能错误:', error);
                    showToast('复制失败，请重试');
                } finally {
                    // 恢复按钮状态
                    const originalText = '<i class="fas fa-copy"></i> 复制排版';
                    copyBtn.innerHTML = originalText;
                    copyBtn.disabled = false;
                    isCopying = false;
                }
            }
            
            // 异步格式化内容准备
            async function prepareContentForCopyAsync() {
                return new Promise((resolve) => {
                    // 使用 requestIdleCallback 在浏览器空闲时处理
                    if (window.requestIdleCallback) {
                        requestIdleCallback(() => {
                            resolve(prepareContentForCopy());
                        }, { timeout: 1000 });
                    } else {
                        // 回退到 setTimeout
                        setTimeout(() => {
                            resolve(prepareContentForCopy());
                        }, 0);
                    }
                });
            }

            // 异步传统复制方法
            async function legacyCopyToClipboardAsync(html) {
                return new Promise((resolve, reject) => {
                    // 使用 requestIdleCallback 在浏览器空闲时处理
                    const processCopy = () => {
                        const tempEl = document.createElement('div');
                        tempEl.style.position = 'absolute';
                        tempEl.style.left = '-9999px';
                        tempEl.style.top = '0';
                        tempEl.style.opacity = '0';
                        tempEl.style.pointerEvents = 'none';
                        document.body.appendChild(tempEl);
                        tempEl.innerHTML = html;

                        try {
                            const range = document.createRange();
                            const selection = window.getSelection();
                            range.selectNodeContents(tempEl);
                            selection.removeAllRanges();
                            selection.addRange(range);

                            const successful = document.execCommand('copy');
                            if (successful) {
                                const duration = performance.now() - startTime;
                                showCopySuccessMessage(duration);
                                resolve();
                            } else {
                                throw new Error('execCommand copy failed');
                            }
                        } catch (err) {
                            console.error('传统复制方法失败:', err);
                            showToast('复制失败，请手动选择内容复制');
                            
                            // 提供手动复制选项
                            showManualCopyOption(html);
                            reject(err);
                        } finally {
                            if (tempEl.parentNode) {
                                document.body.removeChild(tempEl);
                            }
                        }
                    };
                    
                    const startTime = performance.now();
                    
                    if (window.requestIdleCallback) {
                        requestIdleCallback(processCopy, { timeout: 1000 });
                    } else {
                        setTimeout(processCopy, 0);
                    }
                });
            }

            // =================================================================
            // 微信编辑器格式化核心函数 - 最佳实践优化版 V6.0
            // 功能: 将Markdown渲染结果转换为微信编辑器兼容的HTML
            // 优化: 微信兼容性、性能优化、错误处理、缓存机制
            // =================================================================
            
            // 性能优化：缓存机制
            let contentCache = new Map();
            let lastContentHash = '';
            let processingQueue = [];
            let isProcessing = false;
            
            // 性能监控系统 - 增强版
            const performanceMonitor = {
                startTime: 0,
                endTime: 0,
                processingTimes: [],
                cacheHits: 0,
                cacheMisses: 0,
                totalOperations: 0,
                
                getDuration() {
                    return this.endTime - this.startTime;
                },
                
                start() {
                    this.startTime = performance.now();
                },
                
                end() {
                    this.endTime = performance.now();
                    const duration = this.getDuration();
                    this.processingTimes.push(duration);
                    
                    // 保持最近10次的记录
                    if (this.processingTimes.length > 10) {
                        this.processingTimes.shift();
                    }
                    
                    this.totalOperations++;
                    console.log(`微信格式化处理耗时: ${duration.toFixed(2)}ms`);
                    this.updatePerformancePanel();
                },
                
                recordCacheHit() {
                    this.cacheHits++;
                    this.totalOperations++;
                },
                
                recordCacheMiss() {
                    this.cacheMisses++;
                    this.totalOperations++;
                },
                
                getCacheHitRate() {
                    if (this.totalOperations === 0) return 0;
                    return (this.cacheHits / this.totalOperations * 100).toFixed(1);
                },
                
                getAverageProcessingTime() {
                    if (this.processingTimes.length === 0) return 0;
                    const avg = this.processingTimes.reduce((a, b) => a + b, 0) / this.processingTimes.length;
                    return avg.toFixed(0);
                },
                
                getMemoryUsage() {
                    if (performance.memory) {
                        return (performance.memory.usedJSHeapSize / 1024).toFixed(0);
                    }
                    return 'N/A';
                },
                
                updatePerformancePanel() {
                    const panel = document.getElementById('performance-panel');
                    if (!panel) return;
                    
                    const cacheHitRate = document.getElementById('cache-hit-rate');
                    const avgProcessingTime = document.getElementById('avg-processing-time');
                    const memoryUsage = document.getElementById('memory-usage');
                    const optimizationStatus = document.getElementById('optimization-status');
                    
                    if (cacheHitRate) {
                        const rate = this.getCacheHitRate();
                        cacheHitRate.textContent = `${rate}%`;
                        cacheHitRate.className = `value ${rate > 80 ? 'fast' : rate > 50 ? '' : 'slow'}`;
                    }
                    
                    if (avgProcessingTime) {
                        const avg = this.getAverageProcessingTime();
                        avgProcessingTime.textContent = `${avg}ms`;
                        avgProcessingTime.className = `value ${avg < 100 ? 'fast' : avg < 300 ? '' : 'slow'}`;
                    }
                    
                    if (memoryUsage) {
                        const memory = this.getMemoryUsage();
                        memoryUsage.textContent = `${memory}KB`;
                    }
                    
                    if (optimizationStatus) {
                        const avg = parseFloat(this.getAverageProcessingTime());
                        const rate = parseFloat(this.getCacheHitRate());
                        let status = '正常';
                        let className = 'value';
                        
                        if (avg > 500 || rate < 30) {
                            status = '需要优化';
                            className = 'value slow';
                        } else if (avg < 100 && rate > 80) {
                            status = '优秀';
                            className = 'value fast';
                        }
                        
                        optimizationStatus.textContent = status;
                        optimizationStatus.className = className;
                    }
                }
            };

            // 内容哈希生成函数 - 用于缓存判断
            function generateContentHash(content) {
                let hash = 0;
                if (content.length === 0) return hash.toString();
                for (let i = 0; i < content.length; i++) {
                    const char = content.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // 转换为32位整数
                }
                return hash.toString();
            }

            // 批量样式应用优化函数
            function batchApplyStyles(elements, styles, selector = null) {
                if (!elements || elements.length === 0) return;
                
                const styleString = Object.entries(styles)
                    .map(([prop, value]) => {
                        if (value !== undefined && value !== null) {
                            const cssProp = prop.replace(/([A-Z])/g, '-$1').toLowerCase();
                            return `${cssProp}: ${value} !important;`;
                        }
                        return '';
                    })
                    .filter(Boolean)
                    .join(' ');
                
                if (!styleString) return;
                
                elements.forEach(el => {
                    if (el && el.style) {
                        const existingStyle = el.getAttribute('style') || '';
                        el.setAttribute('style', existingStyle + styleString);
                    }
                });
            }

            // 优化的冒号处理函数
            function processColonWrapping(content) {
                if (!content || !content.includes('：')) return content;
                
                // 使用更高效的正则表达式，避免重复处理
                return content.replace(/([^：\s]+：)/g, 
                    '<span style="white-space:nowrap !important; word-break:keep-all !important; word-spacing:0 !important; letter-spacing:normal !important;">$1</span>'
                );
            }

            // 微信兼容性样式模板 - 预定义常用样式
            const wechatStyleTemplates = {
                headings: {
                    color: 'var(--header-color)',
                    fontWeight: 'bold',
                    marginTop: '1.5em',
                    marginBottom: '1em',
                    lineHeight: '1.4'
                },
                paragraphs: {
                    margin: '0 0 1em 0',
                    lineHeight: '1.75',
                    whiteSpace: 'normal',
                    wordBreak: 'normal',
                    wordSpacing: 'normal',
                    overflowWrap: 'break-word',
                    textRendering: 'optimizeLegibility',
                    fontVariantLigatures: 'none',
                    textJustify: 'auto',
                    letterSpacing: 'normal'
                },
                lists: {
                    paddingLeft: '2em',
                    margin: '1.5em 0',
                    whiteSpace: 'normal',
                    wordBreak: 'normal',
                    wordSpacing: 'normal',
                    overflowWrap: 'break-word',
                    textRendering: 'optimizeLegibility',
                    fontVariantLigatures: 'none',
                    textJustify: 'auto'
                },
                listItems: {
                    marginBottom: '0.5em',
                    whiteSpace: 'normal',
                    wordBreak: 'normal',
                    wordSpacing: 'normal',
                    overflowWrap: 'break-word',
                    textRendering: 'optimizeLegibility',
                    fontVariantLigatures: 'none',
                    textJustify: 'auto',
                    letterSpacing: 'normal'
                }
            };

            async function prepareContentForCopy() {
                performanceMonitor.start();
                
                try {
                    // 检查缓存
                    const currentContent = previewOutput.innerHTML;
                    const currentTheme = document.querySelector('.theme-button.selected')?.dataset.theme || 'default';
                    const contentHash = generateContentHash(currentContent + currentTheme);
                    
                    if (contentHash === lastContentHash && contentCache.has(contentHash)) {
                        performanceMonitor.recordCacheHit();
                        performanceMonitor.end();
                        return contentCache.get(contentHash);
                    }
                    
                    performanceMonitor.recordCacheMiss();

                    // 获取当前主题的CSS变量 - 优化变量获取
                    const computedPreviewStyles = window.getComputedStyle(previewOutput);
                    
                    // 微信兼容性优化的默认变量 - 使用对象解构优化
                    const variables = {
                        '--background-color': '#FFFFFF',
                        '--text-color': '#111827',
                        '--header-color': '#1E40AF',
                        '--link-color': '#3B82F6',
                        '--code-bg': '#F3F4F6',
                        '--quote-border': '#D1D5DB',
                        '--table-header': '#F9FAFB',
                        '--table-border': '#E5E7EB',
                        '--intro-bg': '#EBF5FF',
                        '--intro-border': '#3B82F6',
                        '--tip-bg': '#EBF5FF',
                        '--tip-border': '#3B82F6',
                        '--success-bg': '#F0FFF4',
                        '--success-border': '#48BB78',
                        '--warning-bg': '#FFFBEB',
                        '--warning-border': '#F59E0B',
                        '--text-light': '#777',
                        '--highlight-color': '#111827'
                    };
                    
                    // 批量更新变量值
                    Object.keys(variables).forEach(key => {
                        const computedValue = computedPreviewStyles.getPropertyValue(key).trim();
                        if (computedValue) {
                            variables[key] = computedValue;
                        }
                    });

                    // 创建临时DOM元素进行处理 - 使用DocumentFragment优化
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = currentContent;
                    
                    // 批量处理所有元素的基础样式
                    const allElements = tempDiv.querySelectorAll('*');
                    batchApplyStyles(allElements, {
                        'color': variables['--text-color']
                    });

                    // 批量处理标题样式
                    const headings = tempDiv.querySelectorAll('h1, h2, h3, h4, h5, h6');
                    headings.forEach(el => {
                        const baseStyles = { ...wechatStyleTemplates.headings };
                        
                        // 根据标题级别应用特定样式
                        switch (el.tagName) {
                            case 'H1':
                                Object.assign(baseStyles, {
                                    fontSize: '1.875rem',
                                    borderBottom: `2px solid ${variables['--header-color']}`,
                                    paddingBottom: '0.4em'
                                });
                                break;
                            case 'H2':
                                Object.assign(baseStyles, {
                                    fontSize: '1.5rem',
                                    borderBottom: `1px solid ${variables['--header-color']}`,
                                    paddingBottom: '0.3em'
                                });
                                break;
                            case 'H3':
                                baseStyles.fontSize = '1.25rem';
                                break;
                            case 'H4':
                                baseStyles.fontSize = '1.125rem';
                                break;
                            case 'H5':
                                baseStyles.fontSize = '1rem';
                                break;
                            case 'H6':
                                Object.assign(baseStyles, {
                                    fontSize: '0.875rem',
                                    color: variables['--text-light']
                                });
                                break;
                        }
                        
                        batchApplyStyles([el], baseStyles);
                    });

                    // 批量处理strong标签
                    const strongElements = tempDiv.querySelectorAll('strong');
                    strongElements.forEach(strongEl => {
                        const parentHeading = strongEl.closest('h1, h2, h3, h4, h5, h6');
                        batchApplyStyles([strongEl], {
                            color: parentHeading ? 'inherit' : variables['--highlight-color'],
                            fontWeight: 'bold'
                        });
                    });

                    // 优化的自定义块处理
                    const customBlocks = tempDiv.querySelectorAll('.custom-block');
                    const blockStyles = {
                        intro: { backgroundColor: '#EBF5FF', borderLeft: '5px solid #3B82F6' },
                        tip: { backgroundColor: '#EBF5FF', borderLeft: '5px solid #3B82F6' },
                        success: { backgroundColor: '#F0FFF4', borderLeft: '5px solid #48BB78' },
                        warning: { backgroundColor: '#FFFBEB', borderLeft: '5px solid #F59E0B' }
                    };
                    
                    customBlocks.forEach(el => {
                        const type = el.className.match(/(intro|tip|success|warning)/)?.[0];
                        if (blockStyles[type]) {
                            const originalContent = el.innerHTML;
                            const processedContent = processColonWrapping(originalContent);
                            
                            const tableHtml = `
                                <table cellpadding="0" cellspacing="0" border="0" style="width:100%; margin:1.5em 0; border-collapse:collapse;">
                                    <tr>
                                        <td style="background-color:${blockStyles[type].backgroundColor} !important; border-left:${blockStyles[type].borderLeft} !important; padding:16px; border-radius:8px; color:#111827; white-space:normal; word-break:normal; word-spacing:normal; overflow-wrap:break-word; text-rendering:optimizeLegibility; font-variant-ligatures:none; text-justify:auto; letter-spacing:normal;">
                                            ${processedContent}
                                        </td>
                                    </tr>
                                </table>
                            `;
                            el.outerHTML = tableHtml;
                        }
                    });

                    // 批量处理段落
                    const paragraphs = tempDiv.querySelectorAll('p');
                    batchApplyStyles(paragraphs, wechatStyleTemplates.paragraphs);
                    
                    // 处理段落中的冒号
                    paragraphs.forEach(el => {
                        if (el.textContent && el.textContent.includes('：')) {
                            el.innerHTML = processColonWrapping(el.innerHTML);
                        }
                    });

                    // 批量处理链接
                    const links = tempDiv.querySelectorAll('a');
                    batchApplyStyles(links, {
                        color: variables['--link-color'],
                        textDecoration: 'none'
                    });

                    // 批量处理代码块
                    const preElements = tempDiv.querySelectorAll('pre');
                    batchApplyStyles(preElements, {
                        backgroundColor: variables['--code-bg'],
                        padding: '16px',
                        borderRadius: '5px',
                        overflowX: 'auto',
                        margin: '1.5em 0',
                        fontFamily: 'Consolas, Monaco, monospace',
                        fontSize: '1em',
                        lineHeight: '1.6',
                        border: `1px solid ${variables['--table-border']}`
                    });

                    // 批量处理行内代码
                    const inlineCodes = tempDiv.querySelectorAll(':not(pre) > code');
                    batchApplyStyles(inlineCodes, {
                        backgroundColor: variables['--code-bg'],
                        padding: '0.2em 0.4em',
                        borderRadius: '3px',
                        fontFamily: 'Consolas, Monaco, monospace',
                        fontSize: '0.95em'
                    });

                    // 批量处理引用
                    const blockquotes = tempDiv.querySelectorAll('blockquote');
                    batchApplyStyles(blockquotes, {
                        borderLeft: `4px solid ${variables['--quote-border']}`,
                        paddingLeft: '16px',
                        margin: '1.5em 0',
                        opacity: '0.8',
                        fontStyle: 'normal'
                    });

                    // 批量处理列表
                    const lists = tempDiv.querySelectorAll('ul, ol');
                    batchApplyStyles(lists, wechatStyleTemplates.lists);

                    // 批量处理列表项
                    const listItems = tempDiv.querySelectorAll('li');
                    batchApplyStyles(listItems, wechatStyleTemplates.listItems);
                    
                    // 处理列表项中的冒号
                    listItems.forEach(el => {
                        if (el.textContent && el.textContent.includes('：')) {
                            el.innerHTML = processColonWrapping(el.innerHTML);
                        }
                    });

                    // 批量处理表格
                    const tables = tempDiv.querySelectorAll('table');
                    tables.forEach(el => {
                        batchApplyStyles([el], {
                            borderCollapse: 'collapse',
                            width: '100%',
                            margin: '1.5em 0',
                            fontSize: '1em',
                            tableLayout: 'auto',
                            wordBreak: 'break-word'
                        });
                        
                        const cells = el.querySelectorAll('th, td');
                        batchApplyStyles(cells, {
                            border: `1px solid ${variables['--table-border']}`,
                            padding: '8px 12px',
                            textAlign: 'left'
                        });
                        
                        const headers = el.querySelectorAll('th');
                        batchApplyStyles(headers, {
                            backgroundColor: variables['--table-header'],
                            fontWeight: 'bold'
                        });
                    });

                    // 批量处理其他元素
                    const emElements = tempDiv.querySelectorAll('em');
                    batchApplyStyles(emElements, {
                        color: variables['--link-color'],
                        fontStyle: 'italic'
                    });

                    const images = tempDiv.querySelectorAll('img');
                    batchApplyStyles(images, {
                        maxWidth: '100%',
                        height: 'auto',
                        display: 'block',
                        margin: '1.5em auto',
                        borderRadius: '5px'
                    });

                    const hrElements = tempDiv.querySelectorAll('hr');
                    batchApplyStyles(hrElements, {
                        border: 'none',
                        borderTop: `1px dashed ${variables['--table-border']}`,
                        margin: '2em auto',
                        width: '80%'
                    });

                    // 微信兼容性优化的最终包装器
                    const finalHtml = `<section style="background-color:${variables['--background-color']}; color:${variables['--text-color']}; font-family:-apple-system, BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', sans-serif; line-height:1.75; padding:20px 15px; font-size: 16px; white-space:normal; word-break:normal; word-spacing:normal; overflow-wrap:break-word; text-rendering:optimizeLegibility; font-variant-ligatures:none; text-justify:auto;">${tempDiv.innerHTML}</section>`;
                    
                    // 更新缓存
                    lastContentHash = contentHash;
                    contentCache.set(contentHash, finalHtml);
                    
                    // 限制缓存大小，防止内存泄漏
                    if (contentCache.size > 10) {
                        const firstKey = contentCache.keys().next().value;
                        contentCache.delete(firstKey);
                    }
                    
                    performanceMonitor.end();
                    return finalHtml;
                    
                } catch (error) {
                    console.error('微信格式化处理错误:', error);
                    performanceMonitor.end();
                    // 错误处理：返回基本的HTML结构
                    return `<section style="background-color:#FFFFFF; color:#111827; font-family:-apple-system, BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', sans-serif; line-height:1.75; padding:20px 15px; font-size: 16px;">${previewOutput.innerHTML}</section>`;
                }
            }

            // =================================================================
            // END: 微信编辑器格式化核心函数
            // =================================================================

            // =================================================================
            // 用户反馈功能 - 最佳实践优化版
            // =================================================================
            function showCopySuccessMessage(duration = null) {
                if (document.querySelector('.copy-success-tip')) return;
                const successTip = document.createElement('div');
                successTip.className = 'copy-success-tip';
                
                const performanceInfo = duration ? 
                    `<p style="font-size: 12px; opacity: 0.7;">处理耗时: ${duration.toFixed(0)}ms</p>` : '';
                
                successTip.innerHTML = `
                    <div class="success-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="success-text">
                        <h4>复制成功！</h4>
                        <p>已自动优化微信兼容性，请直接粘贴到微信公众号编辑器</p>
                        <p style="font-size: 14px; opacity: 0.8;">支持背景色、冒号错行修复等特性</p>
                        ${performanceInfo}
                    </div>
                `;
                document.body.appendChild(successTip);
                setTimeout(() => {
                    if (successTip.parentNode) {
                        document.body.removeChild(successTip);
                    }
                }, 4000);
            }

            function showManualCopyOption(html) {
                const modal = document.createElement('div');
                modal.className = 'wechat-preview-modal';
                modal.innerHTML = `
                    <div class="wechat-preview-content" style="max-width: 600px;">
                        <div class="wechat-modal-header">
                            <div class="wechat-modal-title">手动复制选项</div>
                            <button class="wechat-modal-close">&times;</button>
                        </div>
                        <div class="wechat-modal-body" style="background-color:#fff; color:#333; padding: 20px;">
                            <p>自动复制失败，请选择以下方式之一：</p>
                            <div style="margin: 20px 0;">
                                <button class="btn-primary" onclick="selectAndCopy()" style="margin: 5px;">选择内容复制</button>
                                <button class="btn-secondary" onclick="downloadAsFile()" style="margin: 5px;">下载HTML文件</button>
                            </div>
                            <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-top: 15px;">
                                <p style="margin: 0; font-size: 14px; color: #666;">
                                    <strong>提示：</strong>如果复制仍有问题，建议使用Chrome或Edge浏览器获得最佳体验。
                                </p>
                            </div>
                        </div>
                        <div class="wechat-modal-footer">
                            <button class="btn-primary" onclick="closeManualCopyModal()">关闭</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // 存储HTML内容供后续使用
                window.tempHtmlContent = html;
                
                const closeModal = () => {
                    if (modal.parentNode) {
                        document.body.removeChild(modal);
                    }
                    delete window.tempHtmlContent;
                };
                modal.querySelector('.wechat-modal-close').addEventListener('click', closeModal);
                modal.querySelector('button[onclick="closeManualCopyModal()"]').addEventListener('click', closeModal);
            }

            // 全局函数供手动复制使用
            window.selectAndCopy = function() {
                if (window.tempHtmlContent) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = window.tempHtmlContent;
                    tempDiv.style.position = 'absolute';
                    tempDiv.style.left = '-9999px';
                    document.body.appendChild(tempDiv);
                    
                    const range = document.createRange();
                    range.selectNodeContents(tempDiv);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                    
                    try {
                        document.execCommand('copy');
                        showToast('内容已选择，请按Ctrl+C复制');
                    } catch (e) {
                        showToast('请手动选择内容后复制');
                    } finally {
                        document.body.removeChild(tempDiv);
                    }
                }
            };

            window.downloadAsFile = function() {
                if (window.tempHtmlContent) {
                    const blob = new Blob([window.tempHtmlContent], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = '微信公众号文章.html';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showToast('HTML文件已下载');
                }
            };

            window.closeManualCopyModal = function() {
                const modal = document.querySelector('.wechat-preview-modal');
                if (modal && modal.parentNode) {
                    document.body.removeChild(modal);
                }
                delete window.tempHtmlContent;
            };

            function showToast(message) {
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            }

            editorToolbar.addEventListener('click', (e) => {
                const button = e.target.closest('.toolbar-button');
                if (!button) return;
                const markers = { intro: '>! ', tip: '>? ', success: '>√ ', warning: '>x ' };
                insertAtCursor(markers[button.dataset.type] || '');
            });

            function insertAtCursor(text) {
                const start = markdownInput.selectionStart;
                const end = markdownInput.selectionEnd;
                const currentText = markdownInput.value;
                markdownInput.value = currentText.substring(0, start) + text + currentText.substring(end);
                markdownInput.selectionEnd = start + text.length;
                markdownInput.focus();
                renderMarkdown();
            }

            // =================================================================
            // 微信兼容性检测 - 最佳实践优化版
            // 功能: 检测HTML内容中可能存在的微信兼容性问题
            // 优化: 更准确的检测、更详细的提示
            // =================================================================
            function getUnsupportedStyles(html) {
                const tips = [];
                const warnings = [];
                const optimizations = [];
                
                // 检测微信不支持的CSS属性
                const unsupportedPatterns = [
                    { pattern: /box-shadow\s*:/i, message: '检测到 box-shadow 阴影样式，微信端可能不显示' },
                    { pattern: /text-shadow\s*:/i, message: '检测到 text-shadow 阴影样式，微信端可能不显示' },
                    { pattern: /filter\s*:/i, message: '检测到滤镜样式（filter），微信端不支持' },
                    { pattern: /backdrop-filter\s*:/i, message: '检测到背景滤镜，微信端不支持' },
                    { pattern: /linear-gradient|radial-gradient|repeating-gradient/i, message: '检测到渐变背景，微信端可能无法显示' },
                    { pattern: /transform\s*:\s*[^;]*rotate|scale|skew/i, message: '检测到CSS变换，微信端可能不支持' },
                    { pattern: /animation\s*:/i, message: '检测到CSS动画，微信端可能不支持' },
                    { pattern: /transition\s*:/i, message: '检测到CSS过渡，微信端可能不支持' }
                ];
                
                unsupportedPatterns.forEach(({ pattern, message }) => {
                    if (pattern.test(html)) {
                        warnings.push(`<span style="color:#F59E0B;font-weight:bold;">⚠️ ${message}</span>`);
                    }
                });
                
                // 检测字体兼容性
                const fontPatterns = [
                    { pattern: /font-family\s*:[^;]*["']?(Fira|JetBrains|Monaco|Menlo|Consolas|Ubuntu)[^;"']*[;"']/i, message: '检测到特殊编程字体，微信端会被系统字体替换' },
                    { pattern: /font-family\s*:[^;]*["']?(Arial|Helvetica)[^;"']*[;"']/i, message: '检测到英文字体，建议使用中文字体' }
                ];
                
                fontPatterns.forEach(({ pattern, message }) => {
                    if (pattern.test(html)) {
                        warnings.push(`<span style="color:#F59E0B;font-weight:bold;">⚠️ ${message}</span>`);
                    }
                });
                
                // 检测已优化的功能
                const optimizationPatterns = [
                    { pattern: /background-color\s*:\s*transparent/i, message: '已优化透明背景为微信兼容模式' },
                    { pattern: /table.*background-color.*#EBF5FF/i, message: '已使用table布局确保背景色正常显示' },
                    { pattern: /white-space.*nowrap.*word-break.*keep-all/i, message: '已为冒号添加特殊处理，防止错行' },
                    { pattern: /text-rendering.*optimizeLegibility/i, message: '已启用文本渲染优化' },
                    { pattern: /!important/i, message: '已为关键样式添加!important确保优先级' },
                    { pattern: /font-family.*PingFang.*Microsoft YaHei/i, message: '已使用微信兼容字体' }
                ];
                
                optimizationPatterns.forEach(({ pattern, message }) => {
                    if (pattern.test(html)) {
                        optimizations.push(`<span style="color:#22C55E;font-weight:bold;">✅ ${message}</span>`);
                    }
                });
                
                // 检测内容结构
                const contentChecks = [
                    { pattern: /<h[1-6]/i, message: '检测到标题结构，已优化微信兼容性' },
                    { pattern: /<table/i, message: '检测到表格结构，已优化微信兼容性' },
                    { pattern: /<ul|<ol/i, message: '检测到列表结构，已优化微信兼容性' },
                    { pattern: /<blockquote/i, message: '检测到引用结构，已优化微信兼容性' }
                ];
                
                contentChecks.forEach(({ pattern, message }) => {
                    if (pattern.test(html)) {
                        optimizations.push(`<span style="color:#22C55E;font-weight:bold;">✅ ${message}</span>`);
                    }
                });
                
                // 组合所有提示
                tips.push(...warnings, ...optimizations);
                
                // 添加总体评估
                if (warnings.length === 0 && optimizations.length > 0) {
                    tips.push('<span style="color:#22C55E;font-weight:bold;">🎉 微信兼容性优秀，可直接使用</span>');
                } else if (warnings.length > 0) {
                    tips.push('<span style="color:#F59E0B;font-weight:bold;">💡 建议在微信编辑器中测试后再发布</span>');
                }
                
                return tips;
            }

            function showWechatPreview() {
                const modal = document.createElement('div');
                modal.className = 'wechat-preview-modal';
                const wechatHtml = prepareContentForCopy();
                const unsupportedTips = getUnsupportedStyles(wechatHtml);

                const currentThemeStyles = window.getComputedStyle(previewOutput);

                modal.innerHTML = `
                <div class="wechat-preview-content">
                    <div class="wechat-modal-header">
                        <div class="wechat-modal-title">微信编辑器预览</div>
                        <button class="wechat-modal-close">&times;</button>
                    </div>
                    <div class="wechat-modal-body">${wechatHtml}
                        ${unsupportedTips.length > 0 ? `<div style='margin:20px 0 0 0; padding: 10px; background: #f8f8f8; border-radius: 5px;'><b>兼容性提醒：</b><ul>${unsupportedTips.map(tip => `<li>${tip}</li>`).join('')}</ul></div>` : ''}
                    </div>
                    <div class="wechat-modal-footer">
                        <p>这是微信公众号编辑器中的预览效果</p>
                        <button class="btn-primary" id="close-preview">关闭预览</button>
                    </div>
                </div>
            `;

                document.body.appendChild(modal);

                const modalBody = modal.querySelector('.wechat-modal-body');
                modalBody.style.backgroundColor = currentThemeStyles.getPropertyValue('--background-color').trim();
                modalBody.style.color = currentThemeStyles.getPropertyValue('--text-color').trim();

                const closeModal = () => {
                    if (modal.parentNode) {
                        document.body.removeChild(modal);
                    }
                    document.body.style.overflow = '';
                };
                modal.querySelector('.wechat-modal-close').addEventListener('click', closeModal);
                modal.querySelector('#close-preview').addEventListener('click', closeModal);
                modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
                document.body.style.overflow = 'hidden';
            }

            function checkCompatibility() {
                const modal = document.createElement('div');
                modal.className = 'wechat-preview-modal';

                const browserInfo = detectBrowser();
                const clipboardSupport = checkClipboardSupport();

                let compatibilityScore = 0;
                let recommendations = [];

                if (clipboardSupport.modern) {
                    compatibilityScore += 50;
                } else if (clipboardSupport.legacy) {
                    compatibilityScore += 25;
                    recommendations.push('您的浏览器不支持现代剪贴板API，建议升级到最新版Chrome/Edge以获得最佳复制体验。');
                } else {
                    recommendations.push('您的浏览器可能不支持复制功能。请尝试使用Chrome或Edge。');
                }

                if (['Chrome', 'Edge'].includes(browserInfo.name) || /360|qqbrowser/i.test(navigator.userAgent)) {
                    compatibilityScore += 50;
                    if (browserInfo.name === 'Unknown') browserInfo.name = 'Chromium内核浏览器';
                } else {
                    recommendations.push(`您正在使用 ${browserInfo.name}。为确保最佳兼容性，推荐使用Chrome、Edge。`);
                }
                if (compatibilityScore > 100) compatibilityScore = 100;

                const wechatHtml = prepareContentForCopy();
                const unsupportedTips = getUnsupportedStyles(wechatHtml);
                if (unsupportedTips.length > 0) {
                    recommendations.push('<b>微信兼容性提醒：</b><br>' + unsupportedTips.join('<br>'));
                }

                let compatibilityRating;
                if (compatibilityScore >= 90) compatibilityRating = '<span style="color:#4CAF50;font-weight:bold;">优秀</span>';
                else if (compatibilityScore >= 70) compatibilityRating = '<span style="color:#FFC107;font-weight:bold;">良好</span>';
                else if (compatibilityScore >= 50) compatibilityRating = '<span style="color:#FF9800;font-weight:bold;">一般</span>';
                else compatibilityRating = '<span style="color:#F44336;font-weight:bold;">较差</span>';

                modal.innerHTML = `
                <div class="wechat-preview-content" style="max-width: 600px;">
                    <div class="wechat-modal-header"><div class="wechat-modal-title">兼容性检测</div><button class="wechat-modal-close">&times;</button></div>
                    <div class="wechat-modal-body" style="background-color:#fff; color:#333; padding: 20px;">
                        <div style="margin-bottom:20px;">
                            <h3 style="margin-top:0;">综合评分: ${compatibilityScore}/100 - ${compatibilityRating}</h3>
                            <div class="progress-bar"><div class="progress" style="width:${compatibilityScore}%;"></div></div>
                        </div>
                        <div style="margin-bottom:20px;">
                            <h4>检测结果</h4>
                            <ul>
                                <li>浏览器: ${browserInfo.name} ${browserInfo.version}</li>
                                <li>操作系统: ${browserInfo.os}</li>
                                <li>现代剪贴板API: ${clipboardSupport.modern ? '✅ 支持' : '❌ 不支持'}</li>
                                <li>传统复制命令: ${clipboardSupport.legacy ? '✅ 支持' : '❌ 不支持'}</li>
                            </ul>
                        </div>
                        ${recommendations.length > 0 ? `<div><h4>兼容性提醒与建议</h4><ul><li>${recommendations.join('</li><li>')}</li></ul></div>` : '<div><h4>检测通过</h4><p>您的浏览器环境与本工具兼容性良好。</p></div>'}
                    </div>
                    <div class="wechat-modal-footer"><button class="btn-primary" id="close-compatibility">确定</button></div>
                </div>
            `;

                document.body.appendChild(modal);
                const closeModal = () => {
                    if (modal.parentNode) document.body.removeChild(modal);
                };
                modal.querySelector('.wechat-modal-close').addEventListener('click', closeModal);
                modal.querySelector('#close-compatibility').addEventListener('click', closeModal);
            }

            function detectBrowser() {
                const ua = navigator.userAgent;
                let browser = "Unknown", version = "N/A", os = "Unknown";

                if (/windows/i.test(ua)) os = "Windows";
                else if (/macintosh|mac os x/i.test(ua)) os = "macOS";
                else if (/linux/i.test(ua)) os = "Linux";
                else if (/android/i.test(ua)) os = "Android";
                else if (/iphone|ipad|ipod/i.test(ua)) os = "iOS";

                let match;
                if ((match = ua.match(/(?:edg|edge)\/([\d.]+)/i))) { browser = 'Edge'; version = match[1]; }
                else if ((match = ua.match(/chrome\/([\d.]+)/i))) { browser = 'Chrome'; version = match[1]; }
                else if ((match = ua.match(/firefox\/([\d.]+)/i))) { browser = 'Firefox'; version = match[1]; }
                else if ((match = ua.match(/version\/([\d.]+).*safari/i))) { browser = 'Safari'; version = match[1]; }

                return { name: browser, version: version, os: os };
            }

            function checkClipboardSupport() {
                return {
                    modern: !!(navigator.clipboard && navigator.clipboard.write),
                    legacy: document.queryCommandSupported && document.queryCommandSupported('copy')
                };
            }

            // 性能监控面板控制
            window.togglePerformancePanel = function() {
                const panel = document.getElementById('performance-panel');
                if (panel) {
                    panel.classList.toggle('show');
                    if (panel.classList.contains('show')) {
                        performanceMonitor.updatePerformancePanel();
                    }
                }
            };

            // 添加性能监控按钮到工具栏
            const performanceBtn = document.createElement('button');
            performanceBtn.className = 'btn-secondary';
            performanceBtn.innerHTML = '<i class="fas fa-tachometer-alt"></i> 性能监控';
            performanceBtn.onclick = togglePerformancePanel;
            performanceBtn.style.marginLeft = '10px';
            
            // 将性能监控按钮添加到控制区域
            const controls = document.querySelector('.controls');
            if (controls) {
                controls.appendChild(performanceBtn);
            }

            markdownInput.addEventListener('input', renderMarkdown);
            clearBtn.addEventListener('click', () => { markdownInput.value = ''; renderMarkdown(); });
            copyBtn.addEventListener('click', copyToClipboard);
            document.querySelectorAll('.theme-button').forEach(button => button.addEventListener('click', (event) => {
                applyTheme(event.target.getAttribute('data-theme'));
            }));
            previewWechatBtn.addEventListener('click', showWechatPreview);
            checkCompatibilityBtn.addEventListener('click', checkCompatibility);

            // Initial render
            renderMarkdown();
        });
    </script>
</body>

</html>
